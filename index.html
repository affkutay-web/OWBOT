<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini Uygulaması</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-color: #2b2b2b;
            --text-color: #f5f5f5;
            --accent-color: #9b59b6;
            --accent-light: #c085e8;
            --glow-color: #a453e9;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-top: 20px;
            opacity: 0;
            animation: fadeIn 0.8s forwards;
        }
        
        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        .card {
            background-color: var(--card-color);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        .profile-header {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
        }
        
        .profile-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .profile-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-color);
            text-transform: uppercase;
        }
        
        .username {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
            color: var(--accent-light);
        }

        .user-id {
            color: #b0b0b0;
            font-size: 16px;
            margin: 4px 0 0;
        }
        
        .user-score {
            font-size: 18px;
            font-weight: 600;
            color: #4CAF50;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-score::before {
            content: '⭐';
        }

        .content-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        h2 {
            font-size: 20px;
            font-weight: 600;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 8px;
            margin-top: 0;
        }

        /* FAQ Stil Kodları */
        .faq-item {
            border-bottom: 1px solid #3a3a3a;
            padding: 15px 0;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .faq-item:last-child {
            border-bottom: none;
        }

        .faq-question {
            font-weight: 600;
            font-size: 16px;
            color: var(--accent-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .faq-question::after {
            content: '+';
            font-size: 24px;
            transition: transform 0.3s ease;
        }
        
        .faq-item.active .faq-question::after {
            content: '-';
            transform: rotate(180deg);
        }

        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            color: #b0b0b0;
            font-size: 14px;
            padding-top: 0;
        }
        
        .faq-item.active .faq-answer {
            max-height: 200px;
            padding-top: 15px;
        }

        /* Kasa Açılımı Stil Kodları */
        .case-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            margin: 20px 0;
        }

        #openCaseBtn {
            padding: 15px 30px;
            background-color: #f7931a;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        #openCaseBtn:hover:not(:disabled) {
            background-color: #ff9d2b;
            transform: translateY(-2px);
        }

        #openCaseBtn:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: none;
        }
        
        .case-animation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .case-prizes-track {
            display: flex;
            height: 120px;
            overflow: hidden;
            width: 90vw;
            border: 3px solid var(--accent-color);
            border-radius: 10px;
            transform: translateX(0);
            transition: transform 7s cubic-bezier(0.25, 0.1, 0.25, 1);
            position: relative;
        }

        .prize-item {
            flex-shrink: 0;
            width: 200px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            border-right: 1px solid #444;
            box-sizing: border-box;
            text-align: center;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            font-size: 14px;
        }
        
        .prize-item.winner {
            box-shadow: 0 0 20px var(--glow-color);
            border: 3px solid var(--glow-color);
            border-radius: 10px;
            transform: scale(1.1);
        }
        
        .prize-pointer {
            position: absolute;
            left: 50%;
            top: 0;
            width: 4px;
            height: 100%;
            background-color: white;
            box-shadow: 0 0 10px white;
            z-index: 10;
            transform: translateX(-50%);
        }
        
        .prize-value {
            font-size: 20px;
            font-weight: bold;
            color: #e0e0e0;
        }
        
        .prize-name {
            font-size: 12px;
            color: #b0b0b0;
            margin-top: 5px;
        }

        .final-prize-display {
            display: none;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-top: 40px;
            animation: fadeIn 0.5s ease-in-out;
        }

        .final-prize-display h3 {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
        }

        .final-prize-display .prize-value {
            font-size: 40px;
            font-weight: 900;
            margin-top: 10px;
            color: var(--glow-color);
            text-shadow: 0 0 15px var(--glow-color);
        }
        
        #prizeMessage {
            margin-top: 15px;
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-light);
            text-align: center;
            min-height: 25px;
        }

        #countdown {
            margin-top: 10px;
            font-size: 14px;
            color: #b0b0b0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card profile-header">
            <div class="profile-info">
                <div id="profileIcon" class="profile-icon">?</div>
                <h1 class="username" id="username">Yükleniyor...</h1>
            </div>
            <p class="user-id" id="userId"></p>
            <p class="user-score" id="userScore">0 Puan</p>
        </div>

        <div class="card content-section">
            <h2>Günlük Ödül Kasası</h2>
            <div class="case-container">
                <button id="openCaseBtn">Kasayı Aç</button>
            </div>
            <div id="prizeMessage"></div>
            <div id="countdown"></div>
        </div>

        <div class="card content-section">
             <h2>Sıkça Sorulan Sorular</h2>
             <div id="faqContainer">
                <!-- FAQ items buraya, değişiklik yok -->
                <div class="faq-item">
                    <div class="faq-question">Nasıl Hesap Açabilirim?</div>
                    <div class="faq-answer">
                        Üye Ol [Kayıt] butonuna tıkladığınızda çıkan kayıt formunu doldurarak kolayca hesap oluşturabilirsiniz. Kayıt sırasında girdiğiniz e-posta adresinizi doğrulamanız gerekmektedir. Adresinizi doğruladığınızda kayıt işlemi de tamamlanacaktır.
                    </div>
                </div>     

          <div class="faq-item">
                    <div class="faq-question">Neden Hesap Açamıyorum?</div>
                    <div class="faq-answer">
                        Daha önce adınıza, e-posta adresinize, telefonunuza, adres bilgilerinize veya IP bilgilerinize kayıtlı bir hesabınız varsa, sistem yeni bir hesap oluşturmanıza izin vermeyecektir. Bu durumda bilgilerinizle birlikte ve sorunu anlatan bir e-posta göndererek müşteri hizmetleri temsilcilerimizden yardım alabilirsiniz.
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">Botu kullanmak güvenli mi?</div>
                    <div class="faq-answer">
                        Evet, botumuz kişisel bilgilerinizi korumak için tasarlanmıştır. Bot, size sadece güncel fırsatları sunar ve kişisel banka bilgilerinize erişemez.
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question">ONWIN’e kayıt olmakla herhangi bir yükümlülük üstleniyor muyum?</div>
                    <div class="faq-answer">
                        Hayır. Siteye kaydınız tamamen bağlayıcılıktan uzaktır ve düzenli olarak para yatırmak veya bahis oynamak mecburiyetiniz yoktur. Bununla birlikte kayıt olmak suretiyle Genel Şirket Şartnamemizi kabul etmiş olursunuz.
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question">Hesabımı Tamamen Nasıl Kapatabilirim?</div>
                    <div class="faq-answer">
                       Üyelikten ayrılmanızı istemeyiz fakat hesabınızı kapatmak isterseniz yapmanız gereken, kapatma talebinizi nedeniyle birlikte e-posta olarak iletmeniz. En kısa sürede size dönüş yapılarak hesap kapatma işlemi gerçekleştirilecektir.
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question">Şifremi Unuttum, Ne Yapmalıyım?</div>
                    <div class="faq-answer">
                        Şifrenizi unuttuysanız üst menüde en sağda yer alan soru işaretine tıklayarak yeni bir şifre talep edebilirsiniz. Bu işlem için e-posta adresinizi veya cep telefonu numaranızı kullanabilirsiniz. Ardından geçici bir şifre kayıtlı e-posta adresinize gönderilir.
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question">Bonusu nasıl çekebilirim?</div>
                    <div class="faq-answer">
                        Verilen bonus tutarının çekilebilmesi için belirli koşulları yerine getirmeniz gereklidir. Bonusun türüne bağlı olarak kazancınızı veya bahis koşullarını yerine getirerek bonus için hesabınıza yatırdığınız tutarı çekebilirsiniz.
Bonuslar, kampanya kural ve şartlarına bağlı olarak bazen oyun oynandıktan önce (çekilmesi kısıtlı bonuslar), bazende oyunlara katıldıktan ve bahis koşulları tümüyle yerine getirildikten sonra oyuncuların hesaplarına işlenir.
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question">Hesabımı doğrulamak zorundamıyım?</div>
                    <div class="faq-answer">
                        Çevrimiçi oyun kuralları uyarınca, yaşı uygun olmayan kişilerin sitemizde oynamadıklarından emin olmak için kimliğinizi ve yaşınızı doğrulamak zorundayız.
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question">Birden fazla hesap açabilir miyim?</div>
                    <div class="faq-answer">
                        Sitemizde aynı isim, adres, telefon, e-posta ve IP adresine bağlı ikinci bir hesap oluşturamazsınız. Böyle bir durumda güvenlik birimlerimiz bunu tespit ederek mevcut hesabınız da dahil olmak üzere tüm hesapları kapatacak ve yeni hesap oluşturmanıza izin vermeyecektir.
                    </div>
                </div>
          </div>
        </div>
    </div>
    <div class="case-animation-overlay" id="caseOverlay">
        <div class="case-prizes-track" id="caseTrack">
            </div>
        <div class="prize-pointer"></div>
        <div class="final-prize-display" id="finalPrizeDisplay">
            <h3 id="finalPrizeName"></h3>
            <p class="prize-value" id="finalPrizeValue"></p>
        </div>
    </div>

    <script>
        const firebaseConfig = {
  apiKey: "AIzaSyBnktrT7Pp7WucJP_xtEu_mmQle_VthRAE",
  authDomain: "onwingiris-afccf.firebaseapp.com",
  databaseURL: "https://onwingiris-afccf-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "onwingiris-afccf",
  storageBucket: "onwingiris-afccf.firebasestorage.app",
  messagingSenderId: "1059998132611",
  appId: "1:1059998132611:web:8ddcf7ed2bd56019796eb6",
  measurementId: "G-DCSV6R5H98"
};
        firebase.initializeApp(firebaseConfig);

        const db = firebase.database();
        const MILLISECONDS_IN_A_DAY = 24 * 60 * 60 * 1000;
        let countdownInterval;

        const prizes = [
            { name: '5 Puan', value: 5, color: '#f7931a' },
            { name: '10 Puan', value: 10, color: '#4CAF50' },
            { name: '20 Puan', value: 20, color: '#2196F3' },
            { name: '50 Puan', value: 50, color: '#9C27B0' },
            { name: '100 Puan', value: 100, color: '#E91E63' },
            { name: '200 Puan', value: 200, color: '#F44336' },
            { name: 'Ekstra Çevirme', value: null, color: '#03A9F4' },
            { name: '30 Puan', value: 30, color: '#FFC107' },
            { name: 'Kaybettin', value: 0, color: '#555' },
            { name: '75 Puan', value: 75, color: '#00BCD4' },
            { name: '150 Puan', value: 150, color: '#8BC34A' },
            { name: 'Şanslısın!', value: 500, color: '#a453e9' }
        ];

        window.addEventListener('load', () => {
            const WebApp = window.Telegram.WebApp;
            WebApp.ready();

            // Buraya bir konsol logu ekleyerek Telegram verisini kontrol ediyoruz
            console.log("WebApp.initDataUnsafe.user:", WebApp.initDataUnsafe.user);
            
            const user = WebApp.initDataUnsafe.user;
            const profileIconElement = document.getElementById('profileIcon');
            const usernameElement = document.getElementById('username');
            const userIdElement = document.getElementById('userId');
            const userScoreElement = document.getElementById('userScore');
            const openCaseBtn = document.getElementById('openCaseBtn');
            const prizeMessage = document.getElementById('prizeMessage');
            const countdownElement = document.getElementById('countdown');
            const caseOverlay = document.getElementById('caseOverlay');
            const caseTrack = document.getElementById('caseTrack');
            const finalPrizeDisplay = document.getElementById('finalPrizeDisplay');
            const finalPrizeName = document.getElementById('finalPrizeName');
            const finalPrizeValue = document.getElementById('finalPrizeValue');

            const faqItems = document.querySelectorAll('.faq-item');
            faqItems.forEach(item => {
                item.addEventListener('click', () => {
                    item.classList.toggle('active');
                });
            });

            if (user) {
                const userName = user.first_name || 'Kullanıcı';
                const userId = user.id;

                usernameElement.textContent = userName;
                userIdElement.textContent = `@${user.username || 'Kullanıcı ID: ' + userId}`;
                if (userName) {
                    profileIconElement.textContent = userName.charAt(0).toUpperCase();
                }

                const userRef = db.ref('users/' + userId);
                const spinRef = db.ref('spins/' + userId);
                const scoreRef = db.ref('scores/' + userId);
                
                userRef.update({
                    firstName: user.first_name,
                    lastName: user.last_name || null,
                    username: user.username || null,
                    lastLogin: firebase.database.ServerValue.TIMESTAMP
                });
                
                scoreRef.on('value', snapshot => {
                    const currentScore = snapshot.val() || 0;
                    userScoreElement.textContent = `${currentScore} Puan`;
                });

                spinRef.once('value').then((snapshot) => {
                    const lastSpinTimestamp = snapshot.val();
                    const now = new Date().getTime();

                    if (lastSpinTimestamp && (now - lastSpinTimestamp) < MILLISECONDS_IN_A_DAY) {
                        openCaseBtn.disabled = true;
                        prizeMessage.textContent = 'Günlük hakkınız bitti.';
                        startCountdown(lastSpinTimestamp);
                    } else {
                        openCaseBtn.disabled = false;
                        prizeMessage.textContent = 'Hemen kasayı aç ve kazan!';
                    }
                });
            } else {
                usernameElement.textContent = 'Kullanıcı verisi alınamadı.';
                userIdElement.textContent = 'Lütfen uygulamayı Telegram içinden açın.';
                profileIconElement.textContent = '?';
                openCaseBtn.disabled = true;
                prizeMessage.textContent = 'Kasayı kullanmak için Telegram\'dan giriş yapın.';
            }

            function startCountdown(lastSpinTimestamp) {
                if (countdownInterval) clearInterval(countdownInterval);
                
                countdownInterval = setInterval(() => {
                    const now = new Date().getTime();
                    const remainingTime = MILLISECONDS_IN_A_DAY - (now - lastSpinTimestamp);
                    
                    if (remainingTime <= 0) {
                        clearInterval(countdownInterval);
                        countdownElement.textContent = 'Kasa açma hakkınız yenilendi!';
                        openCaseBtn.disabled = false;
                        prizeMessage.textContent = 'Hemen kasayı aç ve kazan!';
                        return;
                    }

                    const hours = Math.floor(remainingTime / (1000 * 60 * 60));
                    const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);

                    countdownElement.textContent = `Yeni hak: ${hours}sa ${minutes}dk ${seconds}sn`;
                }, 1000);
            }
            
            function openCase() {
                if (openCaseBtn.disabled || !user) {
                    return;
                }
                
                openCaseBtn.disabled = true;
                caseOverlay.style.display = 'flex';
                
                const prizeList = [];
                for (let i = 0; i < 50; i++) {
                    prizeList.push(...prizes.sort(() => Math.random() - 0.5));
                }

                const winningPrizeIndex = Math.floor(Math.random() * prizes.length);
                const winningPrize = prizes[winningPrizeIndex];

                const winningPrizePosition = Math.floor(Math.random() * 20) + 30;
                prizeList.splice(winningPrizePosition, 0, winningPrize);

                caseTrack.innerHTML = '';
                prizeList.forEach(prize => {
                    const prizeItem = document.createElement('div');
                    prizeItem.className = 'prize-item';
                    prizeItem.style.backgroundColor = prize.color;
                    prizeItem.innerHTML = `<span class="prize-value">${prize.value === null ? '🎁' : prize.value}</span><span class="prize-name">${prize.name}</span>`;
                    caseTrack.appendChild(prizeItem);
                });

                const winningElement = caseTrack.children[winningPrizePosition];
                const winningElementPos = winningElement.offsetLeft + (winningElement.offsetWidth / 2);
                const trackCenter = caseTrack.offsetWidth / 2;
                const finalPosition = trackCenter - winningElementPos;

                caseTrack.style.transition = 'none';
                caseTrack.style.transform = `translateX(0)`;
                
                setTimeout(() => {
                    caseTrack.style.transition = 'transform 7s cubic-bezier(0.25, 0.1, 0.25, 1)';
                    caseTrack.style.transform = `translateX(${finalPosition}px)`;
                }, 10);
                
                setTimeout(() => {
                    caseOverlay.style.display = 'none';
                    prizeMessage.textContent = `Tebrikler, ${winningPrize.name} kazandınız!`;
                    
                    const spinRef = db.ref('spins/' + user.id);
                    const scoreRef = db.ref('scores/' + user.id);
                    
                    if (winningPrize.name === 'Ekstra Çevirme') {
                        spinRef.remove();
                        openCaseBtn.disabled = false;
                        countdownElement.textContent = '';
                    } else if (winningPrize.name === 'Kaybettin') {
                         prizeMessage.textContent = `Maalesef, Kaybettin. Belki bir dahaki sefere...`;
                         spinRef.set(firebase.database.ServerValue.TIMESTAMP);
                         startCountdown(new Date().getTime());
                    } else {
                        scoreRef.transaction(currentScore => {
                            return (currentScore || 0) + winningPrize.value;
                        }).then(() => {
                            spinRef.set(firebase.database.ServerValue.TIMESTAMP);
                            startCountdown(new Date().getTime());
                        });
                    }
                }, 7000);
            }

            openCaseBtn.addEventListener('click', openCase);
        });
    </script>
</body>
</html>

