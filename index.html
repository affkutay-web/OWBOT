<!--
  Bu dosya, bir Telegram Web Uygulaması'nı
  Firebase Firestore ile entegre ederek çok kullanıcılı ve
  gerçek zamanlı veri saklama özelliğine kavuşturur.
  Kullanıcılar bir mini oyundan puan kazanır ve bu puanlarla
  bir bonus çarkını çevirerek kodlar kazanabilir.
-->
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Çarkıfelek Web Uygulaması</title>
    <!-- Tailwind CSS'i dahil etme -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Telegram Web App SDK'sını dahil etme -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase SDK'larını uyumluluk (compat) modunda dahil etme -->
    <!-- Bu, `import` hatalarını önler ve `firebase` nesnesini global olarak erişilebilir kılar. -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <!-- Font Awesome ikonları için CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Varsayılan fontu ayarlama */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%; /* Tüm yüksekliği kaplamalarını sağla */
            width: 100%;
            box-sizing: border-box; /* Padding/border'ı toplam genişlik/yüksekliğe dahil et */
            overflow-x: hidden; /* Sadece yatay kaydırmayı engelle, dikey kaydırmaya izin ver */
        }
        body {
            font-family: 'Inter', sans-serif;
            /* Ana tema arkaplanı mor degrade */
            background: linear-gradient(135deg, #4b0082 0%, #2a0045 100%);
            color: #ffffff; /* Varsayılan yazılar beyaz */
            display: flex;
            flex-direction: column; /* İçeriği dikeyde sırala */
            align-items: center; /* Yatayda ortala */
            justify-content: flex-start; /* İçeriği dikeyde yukarıdan başlat */
        }
        .telegram-btn {
            background-color: var(--tg-theme-button-color, #a78bfa); /* Telegram tema butonu veya mor bir ton */
            color: var(--tg-theme-button-text-color, #ffffff);
            /* Daha dinamik bir düğme görünümü için gölge ve hafif kabartma */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3), 0 3px 8px rgba(0, 0, 0, 0.15), inset 0 -3px 0 rgba(0, 0, 0, 0.2); /* Daha güçlü gölge */
            border-radius: 0.75rem; /* Daha yuvarlak köşeler */
            transition: all 0.2s ease-in-out; /* Yumuşak geçişler */
        }
        .telegram-btn:hover {
            transform: translateY(-3px); /* Hafif yukarı kalkma efekti */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), 0 4px 10px rgba(0, 0, 0, 0.2), inset 0 -4px 0 rgba(0, 0, 0, 0.25); /* Daha da güçlü gölge */
        }
        .telegram-btn:disabled {
            background-color: #555; /* Gri tonu */
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Yükleme ekranı stili */
        #loading-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #4b0082; /* Mor arkaplan */
            color: #ffffff; /* Beyaz yazı */
            z-index: 9999;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3); /* Beyaz spinner, daha şeffaf */
            border-top: 4px solid #a78bfa; /* Mor tonunda spinner üst kenarı */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Mesaj kutusu için stil */
        .message-box { /* Genel bir sınıf yapıldı */
            position: absolute; /* Modalların içinde absolute olarak konumlandırılacak */
            bottom: 1rem; /* Alttan boşluk */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(51, 51, 51, 0.9); /* Mesaj kutusu için daha koyu ve yarı şeffaf bir arka plan */
            color: #ffffff; /* Beyaz yazı */
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
            display: none;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); /* Daha belirgin gölge */
            width: 90%; /* Genişliği ayarla */
            max-width: 300px; /* Maksimum genişlik */
            box-sizing: border-box;
            backdrop-filter: blur(5px); /* Hafif bulanıklık efekti */
        }
        #message-box-home { /* Anasayfa mesaj kutusu için özel konumlandırma */
            position: relative; /* Anasayfa içeriğine göre konumlanır */
            margin-top: 1.5rem; /* Üstten boşluk */
            left: auto;
            transform: none;
            width: auto;
            max-width: none;
        }

        /* Çark stili (modal içinde) */
        .wheel-container {
            position: relative;
            width: min(280px, 90vw); /* Ekran genişliğine göre boyutlandır, max 280px */
            height: min(280px, 90vw); /* En boy oranını koru */
            margin: 0 auto;
            border-radius: 50%;
            overflow: hidden; /* Dilimlerin dışarı taşmasını engelle */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4); /* Daha belirgin gölge */
        }
        .wheel {
            position: relative; /* Dilimler için konteyner */
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transition: transform 5s cubic-bezier(0.1, 0.9, 0.2, 1); /* Hızlı başla, yavaş dur */
            transform-origin: center center;
            overflow: hidden; /* Dilimlerin dışarı taşmasını engelle */
            background: radial-gradient(circle at center, #3a005f 0%, #1a1a1a 100%); /* Çarkın ortasından yayılan degrade */
        }
        .segment { /* Her bir çark diliminin kapsayıcısı */
            position: absolute;
            width: 50%;   /* Yarıçap kadar genişlik */
            height: 100%; /* Tam çap kadar yükseklik */
            top: 0;
            left: 50%;    /* Çarkın merkezinden başla */
            transform-origin: 0% 50%; /* Dönüş noktası çarkın merkezi */
            overflow: hidden; /* İçerideki renkli kısmı gizlemek için */
            transform: rotate(var(--rotation-angle)); /* Dilimi kendi yerine döndür */
        }
        .segment-color-fill { /* Dilimin renkli görünümünü veren kısım */
            position: absolute;
            width: 100%; /* Kapsayıcının tam genişliği */
            height: 100%; /* Kapsayıcının tam yüksekliği */
            left: 0;
            top: 0;
            background-color: var(--segment-color);
            transform-origin: 0% 50%; /* Kapsayıcının sol ortasından dön */
            transform: rotate(var(--segment-sweep-angle)); /* Dilimin yayını oluşturmak için döndür */
            border-radius: 0 100% 100% 0 / 50%; /* Yarım daire şekli */
            opacity: 0.9; /* Hafif şeffaflık */
        }
        .segment-label { /* Dilim üzerindeki okunabilir metin */
            position: absolute;
            top: 50%; /* Dikeyde ortala */
            left: 75%; /* Merkeze göre dışa doğru konumlandır */
            transform: translate(-50%, -50%) rotate(calc(-1 * var(--rotation-angle))); /* Yatayda tutmak için karşıt dönüş */
            white-space: nowrap;
            font-size: 0.8em;
            font-weight: bold;
            color: #ffffff; /* Beyaz metin */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7); /* Daha belirgin gölge */
            z-index: 2; /* Metin dilimin üstünde olsun */
            pointer-events: none; /* Metnin tıklamayı engellememesi için */
            padding: 0 5px; /* Kenarlardan boşluk */
            box-sizing: border-box;
        }
        .wheel-marker {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid #fcd34d; /* Sarımsı renkte ok */
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        /* Sabit başlık stili */
        #app-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(90deg, #2a0045 0%, #4b0082 100%); /* Başlık için degrade */
            color: #ffffff;
            padding: 1rem 1.5rem; /* Yanlara ve dikeyde boşluk */
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4); /* Daha belirgin gölge */
            z-index: 10000; /* Diğer her şeyin üstünde olsun */
            display: flex;
            justify-content: space-between; /* İçeriği iki yana yasla */
            align-items: center; /* Dikeyde ortala */
            box-sizing: border-box;
            height: 60px; /* Başlık için sabit yükseklik */
        }
        #app-header .title {
            font-size: 1.7rem; /* Biraz daha büyük başlık */
            font-weight: 900;
            letter-spacing: 0.08em; /* Harf aralığı */
            text-shadow: 2px 2px 5px rgba(0,0,0,0.7); /* Daha belirgin gölge */
        }
        #app-header .user-info-display {
            text-align: right;
            font-size: 0.9rem;
        }
        #app-header .points-display {
            font-size: 1.25rem; /* Daha büyük puan yazısı */
            font-weight: bold;
            color: #fcd34d; /* Sarımsı renk puanlar için */
            text-shadow: 0 0 8px rgba(252, 211, 77, 0.7); /* Hafif parlama */
        }
        #app-header .points-display .fa-coins { /* Puan ikonuna stil */
            color: #fcd34d;
            margin-right: 0.4rem;
        }

        #app-wrapper {
            flex-grow: 1; /* Kalan tüm dikey boşluğu doldur */
            width: 100%;
            max-width: 600px; /* Genel içerik için maksimum genişlik */
            min-width: 320px; /* Çok dar ekranlarda içeriğin bozulmasını engelle */
            margin: 60px auto 1.5rem auto; /* Üstten sabit, yatayda ortalı, alttan boşluk */
            overflow-y: auto; /* Kendi içinde dikey kaydırma */
            -webkit-overflow-scrolling: touch; /* iOS'ta daha akıcı kaydırma */
            display: flex; /* İçeriğini dikeyde sıralamak için */
            flex-direction: column;
            /* padding-bottom: 1.5rem;  Bu artık margin içinde */
        }

        #home-page-content {
            padding: 1.5rem 1rem; /* İç padding: dikey 1.5rem, yatay 1rem */
            background-color: rgba(26, 26, 26, 0.8); /* Uygulama kapsayıcısı için koyu şeffaf */
            border-radius: 1rem; /* Daha belirgin yuvarlak köşeler */
            margin: 0; /* Artık dış margin yok, app-wrapper yönetecek */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6); /* Daha büyük ve derin gölge */
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* Bölümler arası boşluk */
            align-items: center; /* İçerikleri yatayda ortala */
            flex-grow: 1; /* Home page içeriğinin de kendi içinde büyümesini sağlar */
            backdrop-filter: blur(10px); /* Hafif bulanıklık efekti */
            border: 1px solid rgba(255, 255, 255, 0.15); /* İnce beyaz kenarlık */
        }
        
        /* Başlıklar için renk güncellemesi */
        h1, h2 {
            color: #fcd34d; /* Başlıklar sarımsı olsun */
            font-weight: 900; /* Daha kalın ve etkileyici */
            text-shadow: 0 0 10px rgba(252, 211, 77, 0.8); /* Hafif parlama */
            font-size: 2.5rem; /* H1 için daha büyük */
        }
        h2 {
            font-size: 2rem; /* H2 için daha büyük */
        }

        /* Tüm küçük yazıları beyaz yapalım */
        .text-gray-600 {
            color: #e8e8e8; /* Daha açık gri tonu, daha okunabilir */
        }

        /* Kullanıcı adı giriş modal stili */
        /* Bu kısım artık kullanılmıyor, ancak stil referansı olarak duruyor */
        #username-modal {
            display: none; /* Bu modal artık tamamen gizli */
        }
        .username-modal-content input:focus {
            border-color: #a78bfa; /* Odaklandığında mor kenarlık */
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.4); /* Hafif dış gölge */
            outline: none;
        }

        /* Genel Modal Stili (Çark, Hızlı Tıkla, Sayı Tahmin, Taş Kağıt Makas) */
        .game-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* Daha koyu yarı saydam arka plan */
            display: none; /* Varsayılan olarak gizli */
            align-items: center;
            justify-content: center;
            z-index: 10001;
            opacity: 0;
            transition: opacity 0.3s ease; /* Sadece opacity geçişi */
            backdrop-filter: blur(8px); /* Bulanıklık efekti */
        }
        .game-modal.open {
            opacity: 1;
            /* display: flex; JavaScript tarafından yönetilecek */
        }
        .game-modal-content {
            background: linear-gradient(180deg, #1a1a1a 0%, #333333 100%); /* Degradeli arka plan */
            padding: 2.5rem; /* Daha fazla padding */
            border-radius: 1rem; /* Daha yuvarlak köşeler */
            text-align: center;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5); /* Daha büyük gölge */
            max-width: 90%;
            width: min(400px, 95vw); /* Responsive genişlik */
            position: relative; /* Mesaj kutusu için göreceli konum */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .game-modal-close-btn { /* Modal kapatma butonu için genel sınıf */
            position: absolute;
            top: 15px; /* Konumu ayarla */
            right: 15px; /* Konumu ayarla */
            background: none;
            border: none;
            color: #fcd34d; /* Sarımsı renk */
            font-size: 2.2em; /* Daha büyük */
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .game-modal-close-btn:hover {
            transform: rotate(90deg); /* Kapatırken dönme efekti */
        }

        /* Oyun kartı stili (Ana sayfadaki görsel) */
        .game-card-homepage { /* Ana sayfadaki tıklanabilir oyun kartları */
            background: linear-gradient(145deg, #2a0045 0%, #4b0082 100%); /* Degradeli arka plan */
            padding: 1.5rem;
            border-radius: 1rem; /* Daha yuvarlak köşeler */
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease-in-out; /* Yumuşak geçişler */
            min-width: 250px; /* Her kartın minimum genişliği */
            flex-shrink: 0; /* Kartların küçülmesini engelle */
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4), inset 0 3px 8px rgba(255, 255, 255, 0.15); /* Daha belirgin ve iç gölge */
            border: 1px solid rgba(255, 255, 255, 0.15);
            scroll-snap-align: start; /* Kaydırma hizalaması */
            display: flex; /* İçeriğini ortalamak için */
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .game-card-homepage + .game-card-homepage { /* Kartlar arasına boşluk */
            margin-left: 1.5rem;
        }
        .game-card-homepage:last-child { /* Son karttan sonraki boşluğu kapat */
            margin-right: 1.5rem;
        }

        .game-card-homepage:hover {
            transform: translateY(-10px) scale(1.03); /* Daha belirgin büyüme ve kalkma */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6), inset 0 3px 10px rgba(255, 255, 255, 0.25);
        }
        .game-card-homepage .game-icon { /* İkonlar için stil */
            font-size: 3.5rem; /* İkon boyutu */
            color: #fcd34d; /* Sarımsı renk */
            margin-bottom: 1rem;
            border: 3px solid #fcd34d; /* Sarımsı çerçeve */
            border-radius: 50%; /* Yuvarlak çerçeve */
            width: 100px; /* Sabit genişlik */
            height: 100px; /* Sabit yükseklik */
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0,0,0,0.2); /* Hafif arkaplan */
            box-shadow: 0 0 18px rgba(252, 211, 77, 0.7); /* Resme parlama efekti */
            transition: all 0.3s ease-in-out;
        }
        .game-card-homepage:hover .game-icon {
            transform: scale(1.07); /* Hover'da ikonun da büyümesi */
            box-shadow: 0 0 25px rgba(252, 211, 77, 0.9);
        }
        
        /* Mini Oyunlar bölümü stili */
        #mini-games-carousel-container { /* Carousel için dış konteyner */
            width: 100%;
            position: relative; /* Ok butonları için */
            margin-bottom: 1.5rem; /* Alt boşluk */
        }

        #mini-games-section {
            width: 100%;
            background: linear-gradient(160deg, #2a0045 0%, #3a005f 100%); /* Degradeli arka plan */
            padding: 2rem 1rem; /* Dikey padding, yatay 1rem */
            border-radius: 1rem; /* Daha yuvarlak köşeler */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            display: flex; /* İçindeki oyunları yatayda sırala */
            flex-direction: row; /* Yatay düzen */
            flex-wrap: nowrap; /* Alt satıra geçme */
            gap: 0; /* İç elemanlar arasındaki boşluğu manuel ayarla */
            overflow-x: auto; /* Yatay kaydırma */
            -webkit-overflow-scrolling: touch; /* iOS için akıcı kaydırma */
            scroll-snap-type: x mandatory; /* Kaydırma hizalaması */
            scrollbar-width: none; /* Firefox kaydırma çubuğunu gizle */
            -ms-overflow-style: none;  /* IE and Edge kaydırma çubuğunu gizle */
            margin-bottom: 1rem; /* Oklar ile oyunlar arasına boşluk */
            border: 1px solid rgba(255, 255, 255, 0.1);
            /* Dokunmatik/sürükleme kaydırması için varsayılan cursor */
            cursor: grab;
        }
        #mini-games-section.grabbing {
            cursor: grabbing; /* Sürükleme anında el işareti */
        }


        /* Webkit tabanlı tarayıcılar için kaydırma çubuğunu gizle */
        #mini-games-section::-webkit-scrollbar {
            display: none;
        }

        .scroll-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(75, 0, 130, 0.7); /* Mor yarı şeffaf */
            color: #fcd34d; /* Sarımsı ok */
            border: none;
            padding: 0.5rem 0.8rem;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .scroll-button:hover {
            background-color: rgba(75, 0, 130, 0.9);
            transform: translateY(-50%) scale(1.1);
        }
        #scroll-left-btn {
            left: 5px;
        }
        #scroll-right-btn {
            right: 5px;
        }


        /* Bonus Kodları bölümü stili */
        #bonus-codes-list-section {
            width: 100%;
            background: linear-gradient(160deg, #2a0045 0%, #3a005f 100%); /* Degradeli arka plan */
            padding: 2rem; /* Daha fazla padding */
            border-radius: 1rem; /* Daha yuvarlak köşeler */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #bonus-codes-list li {
            background-color: rgba(75, 0, 130, 0.3); /* Listeler için şeffaf mor arkaplan */
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        #bonus-codes-list li::before {
            content: ''; /* Kontrol edelim, eğer font awesome yeterliyse kaldırılabilir */
            margin-right: 0;
        }
        #bonus-codes-list li .fa-gift {
            color: #fcd34d;
            margin-right: 0.5rem;
        }


        /* Liderlik Tablosu Stili */
        #leaderboard-section {
            width: 100%;
            background: linear-gradient(160deg, #2a0045 0%, #3a005f 100%); /* Degradeli arka plan */
            padding: 2rem; /* Daha fazla padding */
            border-radius: 1rem; /* Daha yuvarlak köşeler */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 1.5rem; /* Diğer bölümlerden üst boşluk */
        }
        #leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #leaderboard-list li {
            background-color: rgba(75, 0, 130, 0.3); /* Listeler için şeffaf mor arkaplan */
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            justify-content: space-between; /* İsim ve puanı iki yana yasla */
            align-items: center;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        #leaderboard-list li span:first-child { /* Sıra ve kullanıcı adı */
            font-weight: bold;
            color: #ffffff;
            display: flex;
            align-items: center;
        }
        #leaderboard-list li span:first-child .fa-trophy {
            color: #fcd34d;
            margin-right: 0.5rem;
        }
        #leaderboard-list li span:last-child { /* Puan */
            font-weight: bold;
            color: #fcd34d; /* Sarımsı renk */
        }


        /* Taş-Kağıt-Makas butonları için düzen */
        #rps-choices {
            display: flex;
            justify-content: center;
            gap: 0.75rem; /* Butonlar arasında boşluk */
            margin-bottom: 1rem;
        }
        #rps-choices .rps-btn {
            padding: 0.75rem 1.25rem;
            font-size: 1.1em;
            font-weight: bold;
            flex: 1; /* Eşit genişlik */
            max-width: 120px; /* Maksimum genişlik */
            /* telegram-btn'in stilini kullanır */
        }
        #rps-result-display-text {
            font-weight: bold;
            margin-bottom: 1rem;
            font-size: 1.3em; /* Daha büyük metin */
            text-shadow: 0 0 5px rgba(255,255,255,0.7);
        }
        #rps-play-again-button {
            background-color: #555; /* Gri tonu */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2), inset 0 -3px 0 rgba(0, 0, 0, 0.2);
        }
        #rps-play-again-button:hover {
            background-color: #666;
            transform: translateY(-1px);
        }
        #rps-player-choice-display, #rps-computer-choice-display {
            font-weight: bold;
            color: #fcd34d; /* Sarımsı renk */
            text-shadow: 0 0 5px rgba(252, 211, 77, 0.5);
        }

        /* Yeni Sekme Navigasyonu Stilleri */
        #tab-navigation {
            width: 100%;
            display: flex;
            justify-content: space-around;
            background-color: rgba(0,0,0,0.3);
            border-radius: 0.75rem;
            padding: 0.5rem;
            margin-bottom: 1.5rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .tab-button {
            flex: 1;
            padding: 0.75rem 0.5rem;
            background: none;
            border: none;
            color: #e8e8e8;
            font-weight: 600;
            font-size: 0.95rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab-button.active {
            background: linear-gradient(45deg, #6f2da8 0%, #a78bfa 100%);
            color: #ffffff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3), inset 0 1px 5px rgba(255,255,255,0.2);
            transform: translateY(-2px);
            font-weight: bold;
        }

        .tab-button:not(.active):hover {
            background-color: rgba(255,255,255,0.1);
            color: #fcd34d;
        }

        .tab-content {
            width: 100%;
            display: none; /* Varsayılan olarak gizli */
            animation: fadeIn 0.5s ease-out; /* İçerik görünür olduğunda animasyon */
        }

        .tab-content.active {
            display: block; /* Aktif olduğunda görünür */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- Yükleme Ekranı -->
    <div id="loading-screen" class="space-y-4">
        <div class="spinner"></div>
        <p class="text-sm">Bağlanıyor...</p>
    </div>

    <!-- Kullanıcı Adı Belirleme Modalı (Artık kullanılmıyor, kaldırıldı) -->

    <!-- Sabit Uygulama Başlığı -->
    <header id="app-header">
        <div class="flex items-center">
            <span class="title">Çarkıfelek Uygulaması</span>
        </div>
        <div class="user-info-display">
            <p id="user-info-header" class="text-sm font-semibold">Yükleniyor...</p>
            <p id="points-display-header" class="points-display"><i class="fa-solid fa-coins"></i> Puan: 0</p>
        </div>
    </header>

    <!-- Ana Uygulama İçeriği (Kaydırılabilir Alan) -->
    <div id="app-wrapper">
        <div id="home-page-content" class="text-center hidden">
            <h1 class="text-3xl font-bold mb-4">Hoş Geldin!</h1>
            <p class="text-sm text-gray-600 mb-6">Puan kazanmak ve bonus kodları almak için oyna!</p>

            <!-- Sekme Navigasyonu -->
            <nav id="tab-navigation">
                <button class="tab-button active" data-tab="games"><i class="fa-solid fa-gamepad"></i> Oyunlar</button>
                <button class="tab-button" data-tab="wheel"><i class="fa-solid fa-gem"></i> Bonus Çarkı</button>
                <button class="tab-button" data-tab="leaderboard"><i class="fa-solid fa-trophy"></i> Liderlik</button>
                <button class="tab-button" data-tab="bonus-codes"><i class="fa-solid fa-gift"></i> Kodlarım</button>
            </nav>

            <!-- Sekme İçerikleri -->
            <div id="tab-content-games" class="tab-content active w-full">
                <!-- Mini Oyunlar Bölümü -->
                <section id="mini-games-carousel-container" class="w-full relative">
                    <h2 class="text-xl font-bold mb-4">Mini Oyunlar</h2>
                    <p class="text-sm text-gray-600 mb-4">Yatay kaydırarak farklı oyunları keşfet ve puan topla!</p>
                    
                    <button id="scroll-left-btn" class="scroll-button -ml-2">‹</button>
                    <div id="mini-games-section">
                        <!-- Mini Oyun Kartı: Hızlı Tıkla! -->
                        <div id="fast-click-card" class="game-card-homepage">
                            <div class="game-icon"><i class="fa-solid fa-hand-pointer"></i></div>
                            <h3 class="text-xl font-bold mb-2">Hızlı Tıkla!</h3>
                            <p class="text-sm text-gray-600">Butona basarak puan kazan.</p>
                        </div>

                        <!-- Mini Oyun Kartı: Sayı Tahmin Oyunu -->
                        <div id="guess-game-card" class="game-card-homepage">
                            <div class="game-icon"><i class="fa-solid fa-dice-one"></i></div>
                            <h3 class="text-xl font-bold mb-2">Sayı Tahmin Oyunu</h3>
                            <p class="text-sm text-gray-600">Sayıyı tahmin et, puanı kap!</p>
                        </div>

                        <!-- Mini Oyun Kartı: Taş, Kağıt, Makas -->
                        <div id="rps-game-card" class="game-card-homepage">
                            <div class="game-icon"><i class="fa-solid fa-hand-fist"></i></div>
                            <h3 class="text-xl font-bold mb-2">Taş, Kağıt, Makas!</h3>
                            <p class="text-sm text-gray-600">Bilgisayarı yen ve puan kazan.</p>
                        </div>

                        <!-- Daha fazla oyun kartı eklenebilir -->
                        <div class="game-card-homepage">
                            <div class="game-icon"><i class="fa-solid fa-star"></i></div>
                            <h3 class="text-xl font-bold mb-2">Yeni Oyun 1</h3>
                            <p class="text-sm text-gray-600">Çok yakında!</p>
                        </div>
                        <div class="game-card-homepage">
                            <div class="game-icon"><i class="fa-solid fa-hourglass-half"></i></div>
                            <h3 class="text-xl font-bold mb-2">Yeni Oyun 2</h3>
                            <p class="text-sm text-gray-600">Geliyor!</p>
                        </div>
                    </div>
                    <button id="scroll-right-btn" class="scroll-button -mr-2">›</button>
                </section>
            </div>

            <div id="tab-content-wheel" class="tab-content w-full">
                <!-- Çarkıfelek Kartı (Artık sekme içeriği) -->
                <div id="wheel-card" class="game-card-homepage">
                    <div class="game-icon"><i class="fa-solid fa-gem"></i></div>
                    <h3 class="text-xl font-bold mb-2">Bonus Çarkı</h3>
                    <p class="text-sm text-gray-600">Çevirmek için tıkla ve bonus kazan!</p>
                </div>
            </div>

            <div id="tab-content-leaderboard" class="tab-content w-full">
                <!-- Liderlik Tablosu Bölümü -->
                <section id="leaderboard-section" class="w-full">
                    <h2 class="text-xl font-bold mb-4">Liderlik Tablosu</h2>
                    <ul id="leaderboard-list" class="text-sm text-gray-600 space-y-2">
                        <!-- Liderler buraya eklenecek -->
                    </ul>
                </section>
            </div>

            <div id="tab-content-bonus-codes" class="tab-content w-full">
                <!-- Bonus Kodları Bölümü -->
                <section id="bonus-codes-list-section" class="w-full">
                    <h2 class="text-xl font-bold mb-4">Kazanılan Bonus Kodları</h2>
                    <ul id="bonus-codes-list" class="text-sm text-gray-600 space-y-2">
                        <!-- Bonus kodları buraya eklenecek -->
                    </ul>
                </section>
            </div>

            <!-- Mesaj kutusu öğesi -->
            <div id="message-box-home" class="message-box"></div>
        </div>
    </div>

    <!-- Tüm Oyun Modalları -->

    <!-- Çarkıfelek Modalı -->
    <div id="wheel-modal" class="game-modal">
        <div class="game-modal-content">
            <button id="wheel-modal-close-btn" class="game-modal-close-btn">×</button>
            <h2 class="text-xl font-bold mb-4">Bonus Çarkı</h2>
            <p class="text-sm text-gray-600 mb-4">Çarkı çevirmek için 100 puana ihtiyacın var.</p>
            <div class="wheel-container">
                <div class="wheel-marker"></div>
                <div id="wheel-element" class="wheel">
                    <!-- Çark dilimleri ve metin etiketleri dinamik olarak eklenecek -->
                </div>
            </div>
            <button id="wheel-spin-button" class="telegram-btn w-full py-3 mt-6 transition duration-200 hover:opacity-80 disabled:opacity-50" disabled>
                <span id="spin-button-text">Çarkı Çevir (100 Puan)</span>
            </button>
            <!-- Mesaj kutusu öğesi (modal içinde) -->
            <div id="message-box-wheel-modal" class="message-box mt-4"></div>
        </div>
    </div>

    <!-- Hızlı Tıkla! Modalı -->
    <div id="fast-click-modal" class="game-modal">
        <div class="game-modal-content">
            <button id="fast-click-modal-close-btn" class="game-modal-close-btn">×</button>
            <h2 class="text-xl font-bold mb-4">Hızlı Tıkla!</h2>
            <p class="text-sm text-gray-600 mb-3">Butona her tıkladığınızda 10 puan kazanırsınız.</p>
            <button id="fast-click-game-button" class="telegram-btn w-full py-3 transition duration-200 hover:opacity-80">
                <span id="fast-click-game-button-text">Puan Kazan (+10)</span>
            </button>
            <div id="message-box-fast-click-modal" class="message-box mt-4"></div>
        </div>
    </div>

    <!-- Sayı Tahmin Oyunu Modalı -->
    <div id="guess-game-modal" class="game-modal">
        <div class="game-modal-content">
            <button id="guess-game-modal-close-btn" class="game-modal-close-btn">×</button>
            <h2 class="text-xl font-bold mb-4">Sayı Tahmin Oyunu</h2>
            <p class="text-sm text-gray-600 mb-3">1 ile 100 arasında bir sayı tuttum. 7 tahmin hakkın var!</p>
            <input type="number" id="guess-game-input" class="w-full p-2 mb-3 rounded-md bg-gray-700 text-white border-none text-center" placeholder="Tahminini gir (1-100)">
            <button id="guess-game-submit-button" class="telegram-btn w-full py-2 mb-2 transition duration-200 hover:opacity-80">Tahmin Et</button>
            <p id="guess-game-feedback" class="text-sm text-gray-400 mb-3"></p>
            <button id="guess-game-new-button" class="telegram-btn bg-gray-500 hover:bg-gray-600 w-full py-2 transition duration-200 hover:opacity-80 hidden">Yeni Oyun Başlat</button>
            <div id="message-box-guess-game-modal" class="message-box mt-4"></div>
        </div>
    </div>

    <!-- Taş, Kağıt, Makas Modalı -->
    <div id="rps-game-modal" class="game-modal">
        <div class="game-modal-content">
            <button id="rps-game-modal-close-btn" class="game-modal-close-btn">×</button>
            <h2 class="text-xl font-bold mb-4">Taş, Kağıt, Makas!</h2>
            <p class="text-sm text-gray-600 mb-3">Bilgisayarı yen, 20 puan kazan!</p>
            <div id="rps-choices" class="flex justify-center gap-3 mb-4">
                <button id="rps-rock-btn" class="rps-btn telegram-btn">Taş</button>
                <button id="rps-paper-btn" class="rps-btn telegram-btn">Kağıt</button>
                <button id="rps-scissors-btn" class="rps-btn telegram-btn">Makas</button>
            </div>
            <div class="mb-3">
                Senin seçimin: <span id="rps-player-choice-display" class="text-yellow-300"></span><br>
                Bilgisayarın seçimi: <span id="rps-computer-choice-display" class="text-yellow-300"></span>
            </div>
            <p id="rps-result-display-text" class="text-base text-white font-bold mb-3"></p>
            <button id="rps-play-again-button" class="telegram-btn bg-gray-500 hover:bg-gray-600 w-full py-2 transition duration-200 hover:opacity-80 hidden">Tekrar Oyna</button>
            <div id="message-box-rps-game-modal" class="message-box mt-4"></div>
        </div>
    </div>


    <script>
        // Firebase ve Uygulama Ayarlarını Global Değişkenlerden Alın
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Kendi firebaseConfig'inizi buraya yapıştırın.
        const firebaseConfig = {
            apiKey: "AIzaSyBnktrT7Pp7WucJP_xtEu_mmQle_VthRAE",
            authDomain: "onwingiris-afccf.firebaseapp.com",
            projectId: "onwingiris-afccf",
            storageBucket: "onwingiris-afccf.firebasestorage.app",
            messagingSenderId: "1059998132611",
            appId: "1:1059998132611:web:7f415159c549366cc796eb6",
            measurementId: "G-RE79PDJSJX"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId, userDocRef;
        let isSpinning = false;
        
        // Bonus çarkı için bölümler - Mor ve siyah tonlarında güncellendi
        const segments = [
            { text: "10 TL Bonus", color: "#6f2da8", type: "bonus_code" }, // Açık mor
            { text: "Tekrar Dene", color: "#1a1a1a", type: "try_again" }, // Siyah
            { text: "25 TL Bonus", color: "#8a2be2", type: "bonus_code" }, // Orta mor
            { text: "Tekrar Dene", color: "#2a0045", type: "try_again" }, // Koyu mor
            { text: "50 TL Bonus", color: "#b19cd9", type: "bonus_code" }, // Lavanta moru
            { text: "Tekrar Dene", color: "#3a005f", type: "try_again" }, // Çok koyu mor
            { text: "25 TL Bonus", color: "#c3aed6", type: "bonus_code" }, // Daha açık lavanta
            { text: "Tekrar Dene", color: "#1a1a1a", type: "try_again" }  // Siyah
        ];

        // HTML elemanları (DOMContentLoaded içinde tanımlanacak)
        let loadingScreen;
        // Kullanıcı adı modali kaldırıldığı için bu değişkenler artık yok: usernameModal, usernameInput, saveUsernameBtn;
        let appHeader, userInfoHeader, pointsDisplayHeader;
        let appWrapper, homePageContent, messageBoxHome;
        
        // Tab navigasyonu elemanları
        let tabButtons, tabContents;

        // Sekme içerik elemanları
        let miniGamesCarouselContainer, miniGamesSection, scrollLeftBtn, scrollRightBtn;
        let wheelCardElement; 
        let leaderboardSection, leaderboardList;
        let bonusCodesListSection, bonusCodesList;
        
        // Anasayfa oyun kartları
        let fastClickCard, guessGameCard, rpsGameCard;
        
        // Kaydırma (sürükleme) için değişkenler
        let isDragging = false;
        let startX;
        let scrollLeftStart;

        // Modallar ve içindeki elemanlar
        let wheelModal, wheelModalCloseBtn, wheelElement, wheelSpinButton, messageBoxWheelModal; 
        let fastClickModal, fastClickModalCloseBtn, fastClickGameButton, messageBoxFastClickModal; 
        let guessGameModal, guessGameModalCloseBtn, guessGameInput, guessGameSubmitButton, guessGameFeedback, guessGameNewButton, messageBoxGuessGameModal; 
        let rpsGameModal, rpsGameModalCloseBtn, rpsRockBtn, rpsPaperBtn, rpsScissorsBtn, rpsPlayerChoiceDisplay, rpsComputerChoiceDisplay, rpsResultDisplayText, rpsPlayAgainButton, messageBoxRpsGameModal; 

        // Sayı Tahmin Oyunu Değişkenleri
        let targetNumber, attemptsLeft, gameOver;
        const MAX_ATTEMPTS = 7;
        const MIN_NUM = 1;
        const MAX_NUM = 100;
        const GUESS_GAME_WIN_POINTS = 50;

        // Taş-Kağıt-Makas Oyunu Değişkenleri
        const choices = ['taş', 'kağıt', 'makas'];
        const RPS_GAME_WIN_POINTS = 20;

        // MODAL YÖNETİMİ BAŞLANGIÇ
        function openModal(modalElement) {
            modalElement.style.display = 'flex'; 
            setTimeout(() => { 
                modalElement.classList.add('open');
            }, 10);
            Telegram.WebApp.HapticFeedback.impactOccurred('light'); 
        }

        function closeModal(modalElement) {
            modalElement.classList.remove('open');
            modalElement.addEventListener('transitionend', function handler() {
                modalElement.style.display = 'none'; 
                modalElement.removeEventListener('transitionend', handler); 
            }, { once: true });
            Telegram.WebApp.HapticFeedback.impactOccurred('light'); 
        }
        // MODAL YÖNETİMİ BİTİŞ

        // Kullanıcıya mesaj göstermek için özel fonksiyon (hedef kutu ID'sine göre)
        function showMessage(text, isError = false, targetBoxId = 'message-box-home') {
            let targetBox = document.getElementById(targetBoxId);
            if (!targetBox) {
                console.error(`Hata: ${targetBoxId} HTML elementi henüz bulunamadı. Mesaj:`, text);
                return;
            }
            targetBox.textContent = text;
            if (isError) {
                targetBox.style.backgroundColor = '#dc3545'; 
            } else {
                targetBox.style.backgroundColor = '#333'; 
            }
            targetBox.style.display = 'block';
            setTimeout(() => {
                targetBox.style.display = 'none';
            }, 3000); 
            Telegram.WebApp.HapticFeedback.notificationOccurred(isError ? 'error' : 'success'); 
        }

        // Çarkı dinamik olarak oluşturma
        function createWheel() {
            const numSegments = segments.length;
            const segmentAngle = 360 / numSegments;
            
            if (wheelElement) wheelElement.innerHTML = ''; 
            
            segments.forEach((segmentData, index) => {
                const rotationAngle = index * segmentAngle; 

                const segmentEl = document.createElement('div');
                segmentEl.className = 'segment';
                segmentEl.style.setProperty('--rotation-angle', `${rotationAngle}deg`);
                segmentEl.style.setProperty('--segment-color', segmentData.color);
                segmentEl.style.setProperty('--segment-sweep-angle', `${segmentAngle}deg`); 

                const colorFillEl = document.createElement('div');
                colorFillEl.className = 'segment-color-fill';
                segmentEl.appendChild(colorFillEl);

                const labelEl = document.createElement('div');
                labelEl.className = 'segment-label';
                labelEl.textContent = segmentData.text;
                labelEl.style.setProperty('--rotation-angle', `${rotationAngle}deg`); 

                segmentEl.appendChild(labelEl);
                if (wheelElement) wheelElement.appendChild(segmentEl);
            });
        }

        // Firebase'i başlat ve kullanıcıyı yetkilendir
        async function initializeFirebase() {
            try {
                // Firebase'i başlatma
                const app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth(); 
                db = firebase.firestore(); 

                // Kullanıcı yetkilendirmesi
                if (initialAuthToken) {
                    await auth.signInWithCustomToken(initialAuthToken);
                } else {
                    await auth.signInAnonymously();
                }

                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        userId = user.uid;
                        userDocRef = db.collection(`artifacts/${appId}/public/data/game_data`).doc(userId);
                        
                        const docSnap = await userDocRef.get();
                        console.log("Firestore docSnap exists:", docSnap.exists, "Data:", docSnap.data()); 

                        let telegramUsername = 'Misafir'; // Varsayılan kullanıcı adı
                        if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
                            const tgUser = Telegram.WebApp.initDataUnsafe.user;
                            if (tgUser.first_name) {
                                telegramUsername = tgUser.first_name;
                                if (tgUser.last_name) {
                                    telegramUsername += ` ${tgUser.last_name}`;
                                }
                            } else {
                                telegramUsername = `Kullanıcı_${tgUser.id}`; 
                            }
                        }

                        if (!docSnap.exists) { 
                            await userDocRef.set({
                                username: telegramUsername, 
                                points: 0,
                                bonusCodes: [],
                                lastClick: 0
                            });
                            console.log("Yeni kullanıcı belgesi Telegram verileriyle oluşturuldu.");
                        } else if (!docSnap.data().username) { 
                            await userDocRef.update({
                                username: telegramUsername 
                            });
                            console.log("Mevcut kullanıcının kullanıcı adı Telegram verileriyle güncellendi.");
                        }
                        
                        // Kullanıcı adı ayarlı olduğu için ana uygulamayı göster
                        loadingScreen.style.display = 'none';
                        if (homePageContent) homePageContent.style.display = 'flex';
                        listenForDataChanges();
                        fetchLeaderboard();
                    } else {
                        console.error("Kimlik doğrulama başarısız oldu, kullanıcı nesnesi boş.");
                        loadingScreen.style.display = 'none';
                        showMessage('Kimlik doğrulama başarısız oldu, lütfen uygulamayı tekrar açın.', true, 'message-box-home');
                    }
                });
            } catch (error) {
                console.error("Firebase başlatılırken bir hata oluştu:", error);
                loadingScreen.style.display = 'none';
                showMessage(`Uygulama başlatılırken bir hata oluştu: ${error.message}`, true, 'message-box-home');
            }
        }
        
        // Firestore'dan gerçek zamanlı veri dinleme
        function listenForDataChanges() {
            userDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    updateUI(data);
                    fetchLeaderboard(); 
                }
            });
        }
        
        // UI'ı verilerle güncelleme
        function updateUI(data) {
            // Header'daki puan ve kullanıcı adını güncelle
            if (pointsDisplayHeader) pointsDisplayHeader.innerHTML = `<i class="fa-solid fa-coins"></i> Puan: ${data.points}`;
            
            if (userInfoHeader) {
                if (data.username) {
                    userInfoHeader.textContent = `Kullanıcı: ${data.username}`;
                } else {
                    userInfoHeader.textContent = `Kullanıcı Kimliği: ${userId}`;
                }
            }
            
            // Bonus kodlarını listele
            if (bonusCodesList) {
                bonusCodesList.innerHTML = '';
                if (data.bonusCodes && data.bonusCodes.length > 0) {
                    data.bonusCodes.forEach(code => {
                        const li = document.createElement('li');
                        li.innerHTML = `<i class="fa-solid fa-gift"></i> ${code}`;
                        bonusCodesList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.textContent = "Henüz kazanılmış bonus kodunuz yok.";
                    bonusCodesList.appendChild(li);
                }
            }

            // Çarkı çevir butonunu etkinleştirme
            if (wheelSpinButton) wheelSpinButton.disabled = data.points < 100 || isSpinning;
        }

        // Liderlik Tablosunu getirme fonksiyonu
        async function fetchLeaderboard() {
            if (!db || !leaderboardList) return;

            try {
                // Sadece kullanıcı adı olan ve en yüksek puana sahip ilk 10 kullanıcıyı getir
                const leaderboardSnapshot = await db.collection(`artifacts/${appId}/public/data/game_data`)
                    .where('username', '!=', null) 
                    .orderBy('points', 'desc') 
                    .limit(10)
                    .get();

                leaderboardList.innerHTML = ''; 
                if (leaderboardSnapshot.empty) {
                    const li = document.createElement('li');
                    li.textContent = "Liderlik tablosu henüz boş.";
                    leaderboardList.appendChild(li);
                    return;
                }

                let rank = 1;
                leaderboardSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.username && data.points !== undefined) { 
                        const li = document.createElement('li');
                        li.innerHTML = `<span><i class="fa-solid fa-trophy"></i> ${rank}. ${data.username}</span><span>${data.points} Puan</span>`;
                        leaderboardList.appendChild(li);
                        rank++;
                    }
                });
            } catch (error) {
                console.error("Liderlik tablosu getirilirken hata oluştu:", error);
                showMessage("Liderlik tablosu yüklenemedi.", true, 'message-box-home');
            }
        }

        // Sayı Tahmin Oyunu Mantığı
        function startGame() {
            targetNumber = Math.floor(Math.random() * (MAX_NUM - MIN_NUM + 1)) + MIN_NUM;
            attemptsLeft = MAX_ATTEMPTS;
            gameOver = false;
            if (guessGameInput) guessGameInput.value = '';
            if (guessGameInput) guessGameInput.disabled = false;
            if (guessGameSubmitButton) guessGameSubmitButton.disabled = false;
            if (guessGameNewButton) guessGameNewButton.classList.add('hidden');
            updateGuessFeedback(`Kalan tahmin hakkı: ${attemptsLeft}`, false); 
        }

        function updateGuessFeedback(message, isError = false) {
            if (guessGameFeedback) {
                guessGameFeedback.textContent = message;
                guessGameFeedback.style.color = isError ? '#dc3545' : '#ffffff';
            }
        }

        async function checkGuess() {
            if (gameOver) return;

            const guess = parseInt(guessGameInput.value);

            if (isNaN(guess) || guess < MIN_NUM || guess > MAX_NUM) {
                updateGuessFeedback(`Lütfen ${MIN_NUM} ile ${MAX_NUM} arasında geçerli bir sayı girin.`, true);
                return;
            }

            attemptsLeft--;

            if (guess === targetNumber) {
                updateGuessFeedback(`Tebrikler! Sayıyı ${MAX_ATTEMPTS - attemptsLeft} tahminde buldun! (+${GUESS_GAME_WIN_POINTS} Puan)`, false);
                gameOver = true;
                if (guessGameInput) guessGameInput.disabled = true;
                if (guessGameSubmitButton) guessGameSubmitButton.disabled = true;
                if (guessGameNewButton) guessGameNewButton.classList.remove('hidden');
                
                // Puanı Firestore'a kaydet
                try {
                    const docSnap = await userDocRef.get();
                    await userDocRef.update({
                        points: (docSnap.data().points || 0) + GUESS_GAME_WIN_POINTS
                    });
                    showMessage(`${GUESS_GAME_WIN_POINTS} puan kazandın!`, false, 'message-box-guess-game-modal');
                } catch (e) {
                    console.error("Puan güncellenirken hata oluştu: ", e);
                    showMessage("Puan kaydedilirken bir hata oluştu.", true, 'message-box-guess-game-modal');
                }

            } else if (attemptsLeft === 0) {
                updateGuessFeedback(`Üzgünüm, tahmin hakkın kalmadı! Sayı ${targetNumber} idi.`, true);
                gameOver = true;
                if (guessGameInput) guessGameInput.disabled = true;
                if (guessGameSubmitButton) guessGameSubmitButton.disabled = true;
                if (guessGameNewButton) guessGameNewButton.classList.remove('hidden');
            } else {
                const hint = guess < targetNumber ? 'daha yüksek' : 'daha düşük';
                updateGuessFeedback(`Yanlış! Sayı ${hint}. Kalan tahmin hakkı: ${attemptsLeft}`);
            }
            if (guessGameInput) guessGameInput.value = ''; 
        }

        // Taş-Kağıt-Makas Oyunu Mantığı
        function initializeRPSGame() {
            if (rpsPlayerChoiceDisplay) rpsPlayerChoiceDisplay.textContent = '';
            if (rpsComputerChoiceDisplay) rpsComputerChoiceDisplay.textContent = '';
            if (rpsResultDisplayText) rpsResultDisplayText.textContent = 'Bir seçim yap!';
            if (rpsRockBtn) rpsRockBtn.disabled = false;
            if (rpsPaperBtn) rpsPaperBtn.disabled = false;
            if (rpsScissorsBtn) rpsScissorsBtn.disabled = false;
            if (rpsPlayAgainButton) rpsPlayAgainButton.classList.add('hidden');
            if (rpsResultDisplayText) rpsResultDisplayText.style.color = '#ffffff'; 
        }

        async function playRPSGame(playerChoice) {
            if (!userId) {
                showMessage("Kullanıcı verisi yükleniyor, lütfen bekleyin.", true, 'message-box-rps-game-modal');
                return;
            }

            if (rpsRockBtn) rpsRockBtn.disabled = true;
            if (rpsPaperBtn) rpsPaperBtn.disabled = true;
            if (rpsScissorsBtn) rpsScissorsBtn.disabled = true;

            const computerChoice = choices[Math.floor(Math.random() * choices.length)];

            if (rpsPlayerChoiceDisplay) rpsPlayerChoiceDisplay.textContent = playerChoice.charAt(0).toUpperCase() + playerChoice.slice(1);
            if (rpsComputerChoiceDisplay) rpsComputerChoiceDisplay.textContent = computerChoice.charAt(0).toUpperCase() + computerChoice.slice(1);

            let result;
            let isWin = false;

            if (playerChoice === computerChoice) {
                result = 'Berabere!';
            } else if (
                (playerChoice === 'taş' && computerChoice === 'makas') ||
                (playerChoice === 'kağıt' && computerChoice === 'taş') ||
                (playerChoice === 'makas' && computerChoice === 'kağıt')
            ) {
                result = 'Kazandın! (+20 Puan)';
                isWin = true;
            } else {
                result = 'Kaybettin.';
            }

            if (rpsResultDisplayText) rpsResultDisplayText.textContent = result;
            if (isWin) {
                if (rpsResultDisplayText) rpsResultDisplayText.style.color = '#a78bfa'; 
                try {
                    const docSnap = await userDocRef.get();
                    await userDocRef.update({
                        points: (docSnap.data().points || 0) + RPS_GAME_WIN_POINTS
                    });
                    showMessage(`${RPS_GAME_WIN_POINTS} puan kazandın!`, false, 'message-box-rps-game-modal');
                } catch (e) {
                    console.error("RPS puanı güncellenirken hata oluştu: ", e);
                    showMessage("Puan kaydedilirken bir hata oluştu.", true, 'message-box-rps-game-modal');
                }
            } else if (result === 'Berabere!') {
                if (rpsResultDisplayText) rpsResultDisplayText.style.color = '#fcd34d'; 
            } else {
                if (rpsResultDisplayText) rpsResultDisplayText.style.color = '#dc3545'; 
            }
            
            if (rpsPlayAgainButton) rpsPlayAgainButton.classList.remove('hidden');
            Telegram.WebApp.HapticFeedback.impactOccurred('medium'); 
        }


        // Uygulama yüklendiğinde başlat
        document.addEventListener('DOMContentLoaded', () => { 
            // HTML elemanlarını DOM yüklendikten sonra al ve global değişkenlere ata
            loadingScreen = document.getElementById('loading-screen');
            // usernameModal, usernameInput, saveUsernameBtn artık kullanılmıyor.

            appHeader = document.getElementById('app-header');
            userInfoHeader = document.getElementById('user-info-header');
            pointsDisplayHeader = document.getElementById('points-display-header');

            appWrapper = document.getElementById('app-wrapper');
            homePageContent = document.getElementById('home-page-content');
            messageBoxHome = document.getElementById('message-box-home');
            
            // Tab navigasyonu elemanlarını al
            tabButtons = document.querySelectorAll('#tab-navigation .tab-button');
            tabContents = {
                'games': document.getElementById('tab-content-games'),
                'wheel': document.getElementById('tab-content-wheel'),
                'leaderboard': document.getElementById('tab-content-leaderboard'),
                'bonus-codes': document.getElementById('tab-content-bonus-codes')
            };

            // Sekme içerik elemanlarını al
            miniGamesCarouselContainer = document.getElementById('mini-games-carousel-container');
            miniGamesSection = document.getElementById('mini-games-section');
            scrollLeftBtn = document.getElementById('scroll-left-btn');
            scrollRightBtn = document.getElementById('scroll-right-btn');
            wheelCardElement = document.getElementById('wheel-card'); 
            leaderboardSection = document.getElementById('leaderboard-section');
            leaderboardList = document.getElementById('leaderboard-list');
            bonusCodesListSection = document.getElementById('bonus-codes-list-section');
            bonusCodesList = document.getElementById('bonus-codes-list');

            // Anasayfa oyun kartları
            fastClickCard = document.getElementById('fast-click-card');
            guessGameCard = document.getElementById('guess-game-card');
            rpsGameCard = document.getElementById('rps-game-card');

            // Modallar ve içindeki elemanlar
            wheelModal = document.getElementById('wheel-modal');
            wheelModalCloseBtn = document.getElementById('wheel-modal-close-btn');
            wheelElement = document.getElementById('wheel-element');
            wheelSpinButton = document.getElementById('wheel-spin-button');
            messageBoxWheelModal = document.getElementById('message-box-wheel-modal');

            fastClickModal = document.getElementById('fast-click-modal');
            fastClickModalCloseBtn = document.getElementById('fast-click-modal-close-btn');
            messageBoxFastClickModal = document.getElementById('message-box-fast-click-modal');
            fastClickGameButton = document.getElementById('fast-click-game-button');

            guessGameModal = document.getElementById('guess-game-modal');
            guessGameModalCloseBtn = document.getElementById('guess-game-modal-close-btn');
            guessGameInput = document.getElementById('guess-game-input');
            guessGameSubmitButton = document.getElementById('guess-game-submit-button');
            guessGameFeedback = document.getElementById('guess-game-feedback');
            guessGameNewButton = document.getElementById('guess-game-new-button');
            messageBoxGuessGameModal = document.getElementById('message-box-guess-game-modal');

            rpsGameModal = document.getElementById('rps-game-modal');
            rpsGameModalCloseBtn = document.getElementById('rps-game-modal-close-btn');
            rpsRockBtn = document.getElementById('rps-rock-btn');
            rpsPaperBtn = document.getElementById('rps-paper-btn');
            rpsScissorsBtn = document.getElementById('rps-scissors-btn');
            rpsPlayerChoiceDisplay = document.getElementById('rps-player-choice-display');
            rpsComputerChoiceDisplay = document.getElementById('rps-computer-choice-display');
            rpsResultDisplayText = document.getElementById('rps-result-display-text');
            rpsPlayAgainButton = document.getElementById('rps-play-again-button');
            messageBoxRpsGameModal = document.getElementById('message-box-rps-game-modal');

            // Kullanıcı adı kaydetme butonu için olay dinleyici (Kaldırıldı)

            // Sekme butonları için olay dinleyicileri
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    Telegram.WebApp.HapticFeedback.impactOccurred('light'); 
                    const targetTab = button.dataset.tab;

                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    for (const key in tabContents) {
                        tabContents[key].classList.remove('active');
                    }
                    if (tabContents[targetTab]) {
                        tabContents[targetTab].classList.add('active');
                    }
                    
                    if (targetTab === 'leaderboard') {
                        fetchLeaderboard();
                    }
                });
            });

            // Hızlı Tıkla! kartına tıklama olayı (modalı açar)
            if (fastClickCard) {
                fastClickCard.addEventListener('click', () => {
                    if (fastClickModal) openModal(fastClickModal);
                });
            }
            // Hızlı Tıkla! modalındaki kapatma butonu
            if (fastClickModalCloseBtn) {
                fastClickModalCloseBtn.addEventListener('click', () => {
                    if (fastClickModal) closeModal(fastClickModal);
                });
            }

            // Sayı Tahmin Oyunu kartına tıklama olayı (modalı açar)
            if (guessGameCard) {
                guessGameCard.addEventListener('click', () => {
                    if (guessGameModal) openModal(guessGameModal);
                    startGame(); 
                });
            }
            // Sayı Tahmin Oyunu modalındaki kapatma butonu
            if (guessGameModalCloseBtn) {
                guessGameModalCloseBtn.addEventListener('click', () => {
                    if (guessGameModal) closeModal(guessGameModal);
                });
            }

            // Taş, Kağıt, Makas kartına tıklama olayı (modalı açar)
            if (rpsGameCard) {
                rpsGameCard.addEventListener('click', () => {
                    if (rpsGameModal) openModal(rpsGameModal);
                    initializeRPSGame(); 
                });
            }
            // Taş, Kağıt, Makas modalındaki kapatma butonu
            if (rpsGameModalCloseBtn) {
                rpsGameModalCloseBtn.addEventListener('click', () => {
                    if (rpsGameModal) closeModal(rpsGameModal);
                });
            }

            // Hızlı Tıkla! butonu için olay dinleyici (modal içinde)
            if (fastClickGameButton) { 
                fastClickGameButton.addEventListener('click', async () => {
                    Telegram.WebApp.HapticFeedback.impactOccurred('light'); 
                    if (!userId) {
                        showMessage("Kullanıcı verisi yükleniyor, lütfen bekleyin.", true, 'message-box-fast-click-modal');
                        return;
                    }

                    const now = Date.now();
                    const docSnap = await userDocRef.get();
                    if (docSnap.exists) {
                        const lastClick = docSnap.data().lastClick || 0;
                        if (now - lastClick < 500) { 
                            showMessage("Çok hızlısın! Lütfen biraz bekle.", false, 'message-box-fast-click-modal');
                            return;
                        }
                    }

                    try {
                        await userDocRef.update({
                            points: (docSnap.data().points || 0) + 10,
                            lastClick: now
                        });
                        showMessage("Puan kazandın!", false, 'message-box-fast-click-modal');
                    } catch (e) {
                        console.error("Puan güncellenirken hata oluştu: ", e);
                        showMessage("Bir hata oluştu, lütfen tekrar deneyin.", true, 'message-box-fast-click-modal');
                    }
                });
            } else {
                console.error("Hata: fastClickGameButton HTML elementi bulunamadı!");
                showMessage("Uygulama yüklenirken bir sorun oluştu (Oyun Butonu bulunamadı).", true, 'message-box-home');
            }

            // Çarkıfelek kartına tıklama olayı (modalı açar)
            if (wheelCardElement) { 
                wheelCardElement.addEventListener('click', () => {
                    if (wheelModal) openModal(wheelModal);
                });
            } else {
                console.error("Hata: wheelCardElement HTML elementi bulunamadı!");
            }

            // Çark modalındaki kapatma butonu
            if (wheelModalCloseBtn) {
                wheelModalCloseBtn.addEventListener('click', () => {
                    if (wheelModal) closeModal(wheelModal);
                });
            } else {
                console.error("Hata: wheelModalCloseBtn HTML elementi bulunamadı!");
            }

            // Çarkı çevir butonu (modal içinde)
            if (wheelSpinButton) { 
                wheelSpinButton.addEventListener('click', async () => {
                    Telegram.WebApp.HapticFeedback.impactOccurred('heavy'); 
                    if (!userId) return;
                    isSpinning = true;
                    wheelSpinButton.disabled = true;
                    wheelSpinButton.textContent = "Çevriliyor...";

                    try {
                        const docSnap = await userDocRef.get();
                        const currentPoints = docSnap.data().points || 0;

                        if (currentPoints < 100) {
                            showMessage("Yeterli puanın yok!", true, 'message-box-wheel-modal');
                            isSpinning = false;
                            wheelSpinButton.disabled = false;
                            wheelSpinButton.textContent = "Çarkı Çevir (100 Puan)";
                            return;
                        }

                        await userDocRef.update({
                            points: currentPoints - 100
                        });

                        const targetSegmentIndex = Math.floor(Math.random() * segments.length);
                        const segmentAngle = 360 / segments.length;
                        const totalAngle = 360 * 5 + (360 - (targetSegmentIndex * segmentAngle + segmentAngle / 2));
                        
                        wheelElement.style.transform = `rotate(${totalAngle}deg)`;
                        
                        setTimeout(async () => {
                            const result = segments[targetSegmentIndex];
                            if (result.type === 'bonus_code') {
                                const newBonusCode = `BONUS-${Math.random().toString(36).substring(2, 10).toUpperCase()}`;
                                await userDocRef.update({
                                    bonusCodes: firebase.firestore.FieldValue.arrayUnion(newBonusCode)
                                });
                                showMessage(`Tebrikler! ${result.text} kazandın. Kodun: ${newBonusCode}`, false, 'message-box-wheel-modal');
                                Telegram.WebApp.HapticFeedback.notificationOccurred('success'); 
                            } else {
                                showMessage("Maalesef, bir dahaki sefere!", false, 'message-box-wheel-modal');
                                Telegram.WebApp.HapticFeedback.notificationOccurred('warning'); 
                            }
                            
                            isSpinning = false;
                            wheelSpinButton.disabled = false;
                            wheelSpinButton.textContent = "Çarkı Çevir (100 Puan)";
                            wheelElement.style.transform = 'rotate(0deg)'; 
                        }, 5000); 
                    } catch (e) {
                        console.error("Çark çevrilirken bir hata oluştu: ", e);
                        showMessage("Bir hata oluştu, lütfen tekrar deneyin.", true, 'message-box-wheel-modal');
                        isSpinning = false;
                        wheelSpinButton.disabled = false;
                        wheelSpinButton.textContent = "Çarkı Çevir (100 Puan)";
                    }
                });
            } else {
                console.error("Hata: wheelSpinButton HTML elementi bulunamadı!");
                showMessage("Uygulama yüklenirken bir sorun oluştu (Çark Butonu bulunamadı).", true, 'message-box-home');
            }
            
            if (wheelElement) {
                createWheel(); 
            } else {
                console.error("Hata: wheelElement HTML elementi bulunamadı!");
            }

            if (guessGameSubmitButton) {
                guessGameSubmitButton.addEventListener('click', () => {
                    Telegram.WebApp.HapticFeedback.impactOccurred('light'); 
                    checkGuess();
                });
            }
            if (guessGameNewButton) {
                guessGameNewButton.addEventListener('click', () => {
                    Telegram.WebApp.HapticFeedback.impactOccurred('light'); 
                    startGame();
                });
            }
            
            if (rpsRockBtn) rpsRockBtn.addEventListener('click', () => playRPSGame('taş'));
            if (rpsPaperBtn) rpsPaperBtn.addEventListener('click', () => playRPSGame('kağıt'));
            if (rpsScissorsBtn) rpsScissorsBtn.addEventListener('click', () => playRPSGame('makas'));
            if (rpsPlayAgainButton) rpsPlayAgainButton.addEventListener('click', () => {
                Telegram.WebApp.HapticFeedback.impactOccurred('light'); 
                initializeRPSGame();
            });
            
            if (scrollLeftBtn && miniGamesSection) {
                scrollLeftBtn.addEventListener('click', () => {
                    Telegram.WebApp.HapticFeedback.impactOccurred('light'); 
                    const firstCard = miniGamesSection.querySelector('.game-card-homepage');
                    if (firstCard) {
                        miniGamesSection.scrollBy({
                            left: -firstCard.offsetWidth - 24, 
                            behavior: 'smooth'
                        });
                    }
                });
            }
            if (scrollRightBtn && miniGamesSection) {
                scrollRightBtn.addEventListener('click', () => {
                    Telegram.WebApp.HapticFeedback.impactOccurred('light'); 
                    const firstCard = miniGamesSection.querySelector('.game-card-homepage');
                    if (firstCard) {
                        miniGamesSection.scrollBy({
                            left: firstCard.offsetWidth + 24, 
                            behavior: 'smooth'
                        });
                    }
                });
            }
            
            if (miniGamesSection) {
                miniGamesSection.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    miniGamesSection.classList.add('grabbing'); 
                    startX = e.pageX - miniGamesSection.offsetLeft;
                    scrollLeftStart = miniGamesSection.scrollLeft;
                    e.preventDefault(); 
                });

                miniGamesSection.addEventListener('mouseleave', () => {
                    isDragging = false;
                    miniGamesSection.classList.remove('grabbing');
                });

                miniGamesSection.addEventListener('mouseup', () => {
                    isDragging = false;
                    miniGamesSection.classList.remove('grabbing');
                });

                miniGamesSection.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    const x = e.pageX - miniGamesSection.offsetLeft;
                    const walk = (x - startX) * 1.5; 
                    miniGamesSection.scrollLeft = scrollLeftStart - walk;
                });

                miniGamesSection.addEventListener('touchstart', (e) => {
                    isDragging = true;
                    startX = e.touches[0].pageX - miniGamesSection.offsetLeft;
                    scrollLeftStart = miniGamesSection.scrollLeft;
                });

                miniGamesSection.addEventListener('touchend', () => {
                    isDragging = false;
                });

                miniGamesSection.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    e.preventDefault(); 
                    const x = e.touches[0].pageX - miniGamesSection.offsetLeft;
                    const walk = (x - startX) * 1.5; 
                    miniGamesSection.scrollLeft = scrollLeftStart - walk;
                });
            }


            initializeFirebase();
        });
    </script>
</body>
</html>
