<!--
  Bu dosya, bir Telegram Web Uygulaması'nı
  Firebase Firestore ile entegre ederek çok kullanıcılı ve
  gerçek zamanlı veri saklama özelliğine kavuşturur.
  Kullanıcılar bir mini oyundan puan kazanır ve bu puanlarla
  bir bonus çarkını çevirerek kodlar kazanabilir.
-->
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Çarkıfelek Web Uygulaması</title>
    <!-- Tailwind CSS'i dahil etme -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Telegram Web App SDK'sını dahil etme -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase SDK'larını uyumluluk (compat) modunda dahil etme -->
    <!-- Bu, `import` hatalarını önler ve `firebase` nesnesini global olarak erişilebilir kılar. -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <style>
        /* Varsayılan fontu ayarlama */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tg-theme-bg-color, #f4f4f4);
            color: var(--tg-theme-text-color, #000000);
            display: flex; /* Ekranın ortalanması için */
            flex-direction: column; /* İçeriğin dikeyde hizalanması için */
            align-items: center;
            justify-content: flex-start; /* İçeriği yukarıdan başlat */
            min-height: 100vh; /* Minimum viewport yüksekliği */
            margin: 0;
            padding: 1.5rem; /* Genel padding ekle */
            overflow-y: auto; /* Dikeyde kaydırmaya izin ver */
            overflow-x: hidden; /* Yatayda kaydırmayı engelle */
            box-sizing: border-box; /* Padding'in genişliğe dahil olmasını sağla */
        }
        .telegram-btn {
            background-color: var(--tg-theme-button-color, #50a8eb);
            color: var(--tg-theme-button-text-color, #ffffff);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border-radius: 0.5rem; /* Yuvarlak köşeler */
        }
        /* Yükleme ekranı stili */
        #loading-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--tg-theme-bg-color, #f4f4f4);
            z-index: 9999;
        }
        .spinner {
            border: 4px solid var(--tg-theme-hint-color, #999);
            border-top: 4px solid var(--tg-theme-button-color, #50a8eb);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Mesaj kutusu için stil */
        #message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
            display: none;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        /* Çark stili */
        .wheel-container {
            position: relative;
            width: 280px; /* Daha büyük çark */
            height: 280px; /* Daha büyük çark */
            margin: 0 auto;
            border-radius: 50%;
            overflow: hidden; /* Dilimlerin dışarı taşmasını engelle */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            margin-bottom: 1.5rem; /* Altına boşluk bırak */
        }
        .wheel {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transition: transform 5s cubic-bezier(0.1, 0.9, 0.2, 1); /* Hızlı başla, yavaş dur */
            transform-origin: center center;
        }
        .segment { /* Her bir çark diliminin kapsayıcısı */
            position: absolute;
            top: 0;
            right: 0;
            width: 50%;
            height: 50%;
            transform-origin: 0% 100%; /* Çarkın ortasından dönsün */
            overflow: hidden; /* Yarım daireyi gizle */
        }
        .segment:nth-child(odd) { /* Tek sayılı dilimler için sağ yarıyı kullan */
            left: 50%;
            right: auto;
            transform-origin: 0% 100%;
        }
        .segment:nth-child(even) { /* Çift sayılı dilimler için sol yarıyı kullan */
            left: 0;
            right: auto;
            transform-origin: 100% 100%;
        }

        .segment-half { /* Dilimin görsel yarısı */
            position: absolute;
            width: 200%; /* Tam daire oluşturmak için */
            height: 200%;
            top: 0;
            left: 0;
            border-radius: 50%;
            background-color: var(--segment-color); /* JavaScript'ten renk */
            box-sizing: border-box;
            transform-origin: 25% 25%; /* Doğru merkez noktasından dönüş için */
            transform: rotate(var(--half-rotation)); /* JavaScript'ten dönüş */
        }
        .segment-label { /* Dilim üzerindeki okunabilir metin */
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.85em;
            font-weight: bold;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            pointer-events: none; /* Metnin tıklamayı engellememesi için */
            /* Metni yatay tutmak için dönüşler */
            transform: translate(calc(var(--text-offset-x) * 1px), calc(var(--text-offset-y) * 1px)) rotate(var(--label-rotation));
            left: 0;
            top: 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5); /* Okunabilirliği artır */
            padding: 0 5px; /* Kenarlardan boşluk */
            box-sizing: border-box;
        }
        .wheel-marker {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid var(--tg-theme-button-color, #50a8eb);
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        .app-container {
            width: 100%;
            max-width: 600px; /* Daha geniş cihazlarda daha iyi görünüm */
            margin: auto; /* Ortalamak için */
            padding: 1.5rem; /* İç padding */
            box-sizing: border-box; /* Padding'in genişliğe dahil olmasını sağla */
        }
    </style>
</head>
<body class="p-6">
    <!-- Yükleme Ekranı -->
    <div id="loading-screen" class="space-y-4">
        <div class="spinner"></div>
        <p class="text-sm">Bağlanıyor...</p>
    </div>

    <div id="app-container" class="bg-white rounded-lg shadow-xl p-8 text-center hidden">
        <h1 class="text-3xl font-bold mb-2">Bonus Çarkı Uygulaması</h1>
        <p class="text-sm text-gray-600 mb-6">Puan kazanmak ve bonus kodları almak için oyna!</p>
        
        <!-- Kullanıcı Bilgisi -->
        <div class="bg-gray-100 p-4 rounded-lg mb-6">
            <p id="user-info" class="text-sm font-semibold mb-2">Yükleniyor...</p>
            <p id="points-display" class="text-2xl font-bold text-blue-600">Puan: 0</p>
        </div>
        
        <!-- Mini Oyun Bölümü -->
        <div class="border-b border-gray-200 pb-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Mini Oyun</h2>
            <p class="text-sm text-gray-600 mb-4">Butona her tıkladığınızda puan kazanırsınız.</p>
            <button id="game-button" class="telegram-btn w-full py-3 rounded-lg font-semibold transition duration-200 hover:opacity-80">
                <span id="game-button-text">Puan Kazan (+10)</span>
            </button>
        </div>
        
        <!-- Çarkıfelek Bölümü -->
        <div class="border-b border-gray-200 pb-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Bonus Çarkı</h2>
            <p class="text-sm text-gray-600 mb-4">Çarkı çevirmek için 100 puana ihtiyacın var.</p>
            <div class="wheel-container">
                <div class="wheel-marker"></div>
                <div id="wheel" class="wheel">
                    <!-- Çark dilimleri ve metin etiketleri dinamik olarak eklenecek -->
                </div>
            </div>
            <button id="spin-button" class="telegram-btn w-full py-3 mt-6 rounded-lg font-semibold transition duration-200 hover:opacity-80 disabled:opacity-50" disabled>
                <span id="spin-button-text">Çarkı Çevir (100 Puan)</span>
            </button>
        </div>
        
        <!-- Bonus Kodları Bölümü -->
        <div>
            <h2 class="text-xl font-bold mb-4">Kazanılan Bonus Kodları</h2>
            <ul id="bonus-codes-list" class="text-sm text-gray-600 space-y-2">
                <!-- Bonus kodları buraya eklenecek -->
            </ul>
        </div>
        
        <!-- Mesaj kutusu öğesi -->
        <div id="message-box"></div>

        <!-- Uygulamayı kapatma butonu -->
        <button id="close-button" class="telegram-btn w-full py-3 mt-6 rounded-lg font-semibold transition duration-200 hover:opacity-80">
            Uygulamayı Kapat
        </button>
    </div>

    <script>
        // Firebase ve Uygulama Ayarlarını Global Değişkenlerden Alın
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Kendi firebaseConfig'inizi buraya yapıştırın.
        const firebaseConfig = {
            apiKey: "AIzaSyBnktrT7Pp7WucJP_xtEu_mmQle_VthRAE",
            authDomain: "onwingiris-afccf.firebaseapp.com",
            projectId: "onwingiris-afccf",
            storageBucket: "onwingiris-afccf.firebasestorage.app",
            messagingSenderId: "1059998132611",
            appId: "1:1059998132611:web:7f415159c54936cc796eb6",
            measurementId: "G-RE79PDJSJX"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId, userDocRef;
        let isSpinning = false;
        
        // Bonus çarkı için bölümler
        const segments = [
            { text: "10 TL Bonus", color: "#FF6384", type: "bonus_code" },
            { text: "Tekrar Dene", color: "#36A2EB", type: "try_again" },
            { text: "25 TL Bonus", color: "#FFCE56", type: "bonus_code" },
            { text: "Tekrar Dene", color: "#4BC0C0", type: "try_again" },
            { text: "50 TL Bonus", color: "#9966FF", type: "bonus_code" },
            { text: "Tekrar Dene", color: "#FF9F40", type: "try_again" },
            { text: "25 TL Bonus", color: "#B3F7B3", type: "bonus_code" },
            { text: "Tekrar Dene", color: "#E0E0E0", type: "try_again" }
        ];

        // HTML elemanları (DOMContentLoaded içinde tanımlanacak)
        let loadingScreen, appContainer, userInfoElement, pointsDisplay, gameButton, spinButton, bonusCodesList, messageBox, wheel, closeButton;


        // Kullanıcıya mesaj göstermek için özel fonksiyon
        function showMessage(text, isError = false) {
            if (!messageBox) { 
                console.error("Hata: messageBox HTML elementi henüz bulunamadı. Mesaj:", text);
                return;
            }
            messageBox.textContent = text;
            if (isError) {
                messageBox.style.backgroundColor = '#dc3545'; // Kırmızı arka plan
            } else {
                messageBox.style.backgroundColor = '#333'; // Varsayılan arka plan
            }
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000); // 3 saniye sonra gizle
        }

        // Çarkı dinamik olarak oluşturma
        function createWheel() {
            const segmentAngle = 360 / segments.length;
            wheel.innerHTML = ''; // Çarkı temizle

            segments.forEach((segment, index) => {
                const rotationAngle = index * segmentAngle;
                const midAngle = rotationAngle + segmentAngle / 2;

                const segmentEl = document.createElement('div');
                segmentEl.className = 'segment';
                segmentEl.style.transform = `rotate(${rotationAngle}deg)`;
                segmentEl.style.setProperty('--segment-color', segment.color);

                // CSS 'half-circle' tekniği için dönüş
                // Her dilim aslında çarkın 1/2'si kadar büyüklükte bir 'segment' kapsayıcının içinde
                // yer alan tam boy bir dairenin belirli bir kısmını gösterir.
                // Bu daire, 'segment' kapsayıcısı döndürüldükten sonra kendi içinde belirli bir açıyla döndürülerek
                // dilimin üçgenimsi görüntüsü oluşturulur.
                const halfCircleEl = document.createElement('div');
                halfCircleEl.className = 'segment-half';
                // segmentAngle 180'den büyükse, yarım dairenin dönme açısı ona göre ayarlanır.
                halfCircleEl.style.setProperty('--half-rotation', `${Math.min(segmentAngle, 180)}deg`); 
                segmentEl.appendChild(halfCircleEl);

                const labelEl = document.createElement('div');
                labelEl.className = 'segment-label';
                labelEl.textContent = segment.text;
                
                // Metni yatay tutmak ve doğru konumlandırmak için hesaplamalar
                const radius = 90; // Çark merkezinden metin uzaklığı (çarkın yarıçapına göre ayarlanabilir)
                const textX = radius * Math.cos((midAngle - 90) * Math.PI / 180);
                const textY = radius * Math.sin((midAngle - 90) * Math.PI / 180);

                // CSS değişkenleri ile metin konumunu ve dönüşünü ayarla
                labelEl.style.setProperty('--text-offset-x', `${textX}`);
                labelEl.style.setProperty('--text-offset-y', `${textY}`);
                labelEl.style.setProperty('--label-rotation', `${-midAngle}deg`); // Metni yatay tutmak için ters dönüş

                segmentEl.appendChild(labelEl);
                wheel.appendChild(segmentEl);
            });
        }

        // Firebase'i başlat ve kullanıcıyı yetkilendir
        async function initializeFirebase() {
            try {
                // Firebase'i başlatma
                const app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth(); // compat versiyonunda bu şekilde
                db = firebase.firestore(); // compat versiyonunda bu şekilde

                // Kullanıcı yetkilendirmesi
                if (initialAuthToken) {
                    await auth.signInWithCustomToken(initialAuthToken);
                } else {
                    await auth.signInAnonymously();
                }

                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Firestore collection ve doc referanslarını düzeltme
                        userDocRef = db.collection(`artifacts/${appId}/public/data/game_data`).doc(userId);
                        
                        // Kullanıcı verilerini Firestore'dan al veya oluştur
                        const docSnap = await userDocRef.get();
                        if (!docSnap.exists) {
                            await userDocRef.set({
                                points: 0,
                                bonusCodes: [],
                                lastClick: 0
                            });
                        }
                        
                        // UI'ı göster ve veriyi dinlemeye başla
                        loadingScreen.style.display = 'none';
                        appContainer.style.display = 'block';
                        listenForDataChanges();
                    } else {
                        // Eğer kimlik doğrulama başarısız olursa, bir hata mesajı göster
                        console.error("Kimlik doğrulama başarısız oldu, kullanıcı nesnesi boş.");
                        loadingScreen.style.display = 'none';
                        showMessage('Kimlik doğrulama başarısız oldu, lütfen uygulamayı tekrar açın.', true);
                    }
                });
            } catch (error) {
                // Firebase başlatılırken veya kimlik doğrulanırken oluşan hataları yakala
                console.error("Firebase başlatılırken bir hata oluştu:", error);
                loadingScreen.style.display = 'none';
                showMessage(`Uygulama başlatılırken bir hata oluştu: ${error.message}`, true);
            }
        }
        
        // Firestore'dan gerçek zamanlı veri dinleme
        function listenForDataChanges() {
            userDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    updateUI(data);
                }
            });
        }
        
        // UI'ı verilerle güncelleme
        function updateUI(data) {
            pointsDisplay.textContent = `Puan: ${data.points}`;
            
            // Bonus kodlarını listele
            bonusCodesList.innerHTML = '';
            if (data.bonusCodes && data.bonusCodes.length > 0) {
                data.bonusCodes.forEach(code => {
                    const li = document.createElement('li');
                    li.textContent = `• ${code}`;
                    bonusCodesList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = "Henüz kazanılmış bonus kodunuz yok.";
                bonusCodesList.appendChild(li);
            }

            // Çarkı çevir butonunu etkinleştirme
            spinButton.disabled = data.points < 100 || isSpinning;
            
            // Kullanıcı kimliğini göster
            userInfoElement.textContent = `Kullanıcı Kimliği: ${userId}`;
        }

        // Uygulama yüklendiğinde başlat
        document.addEventListener('DOMContentLoaded', () => { 
            // HTML elemanlarını DOM yüklendikten sonra al ve global değişkenlere ata
            loadingScreen = document.getElementById('loading-screen');
            appContainer = document.getElementById('app-container');
            userInfoElement = document.getElementById('user-info');
            pointsDisplay = document.getElementById('points-display');
            gameButton = document.getElementById('game-button');
            spinButton = document.getElementById('spin-button');
            bonusCodesList = document.getElementById('bonus-codes-list');
            messageBox = document.getElementById('message-box');
            wheel = document.getElementById('wheel');
            closeButton = document.getElementById('close-button');

            // DOM elemanları atandıktan sonra olay dinleyicilerini ekle
            if (gameButton) { 
                gameButton.addEventListener('click', async () => {
                    if (!userId) {
                        showMessage("Kullanıcı verisi yükleniyor, lütfen bekleyin.", true);
                        return;
                    }

                    const now = Date.now();
                    const docSnap = await userDocRef.get();
                    if (docSnap.exists) {
                        const lastClick = docSnap.data().lastClick || 0;
                        if (now - lastClick < 500) { 
                            showMessage("Çok hızlısın! Lütfen biraz bekle.");
                            return;
                        }
                    }

                    try {
                        await userDocRef.update({
                            points: (docSnap.data().points || 0) + 10,
                            lastClick: now
                        });
                        showMessage("Puan kazandın!");
                    } catch (e) {
                        console.error("Puan güncellenirken hata oluştu: ", e);
                        showMessage("Bir hata oluştu, lütfen tekrar deneyin.", true);
                    }
                });
            } else {
                console.error("Hata: gameButton HTML elementi bulunamadı!");
                showMessage("Uygulama yüklenirken bir sorun oluştu (Oyun Butonu bulunamadı).", true);
            }

            if (spinButton) { 
                spinButton.addEventListener('click', async () => {
                    if (!userId) return;
                    isSpinning = true;
                    spinButton.disabled = true;
                    spinButton.textContent = "Çevriliyor...";

                    try {
                        const docSnap = await userDocRef.get();
                        const currentPoints = docSnap.data().points || 0;

                        if (currentPoints < 100) {
                            showMessage("Yeterli puanın yok!", true);
                            isSpinning = false;
                            spinButton.disabled = false;
                            spinButton.textContent = "Çarkı Çevir (100 Puan)";
                            return;
                        }

                        await userDocRef.update({
                            points: currentPoints - 100
                        });

                        const targetSegmentIndex = Math.floor(Math.random() * segments.length);
                        const segmentAngle = 360 / segments.length;
                        const totalAngle = 360 * 5 + (360 - (targetSegmentIndex * segmentAngle + segmentAngle / 2));
                        
                        wheel.style.transform = `rotate(${totalAngle}deg)`;
                        
                        setTimeout(async () => {
                            const result = segments[targetSegmentIndex];
                            if (result.type === 'bonus_code') {
                                const newBonusCode = `BONUS-${Math.random().toString(36).substring(2, 10).toUpperCase()}`;
                                await userDocRef.update({
                                    bonusCodes: firebase.firestore.FieldValue.arrayUnion(newBonusCode)
                                });
                                showMessage(`Tebrikler! ${result.text} kazandın. Kodun: ${newBonusCode}`);
                            } else {
                                showMessage("Maalesef, bir dahaki sefere!");
                            }
                            
                            isSpinning = false;
                            spinButton.disabled = false;
                            spinButton.textContent = "Çarkı Çevir (100 Puan)";
                            wheel.style.transform = 'rotate(0deg)'; // Çarkı başlangıç konumuna döndür
                        }, 5000); // 5 saniye animasyon süresi
                    } catch (e) {
                        console.error("Çark çevrilirken bir hata oluştu: ", e);
                        showMessage("Bir hata oluştu, lütfen tekrar deneyin.", true);
                        isSpinning = false;
                        spinButton.disabled = false;
                        spinButton.textContent = "Çarkı Çevir (100 Puan)";
                    }
                });
            } else {
                console.error("Hata: spinButton HTML elementi bulunamadı!");
                showMessage("Uygulama yüklenirken bir sorun oluştu (Çark Butonu bulunamadı).", true);
            }
            
            if (closeButton) { 
                closeButton.addEventListener('click', () => {
                    window.Telegram.WebApp.close();
                });
            } else {
                console.error("Hata: closeButton HTML elementi bulunamadı!");
                showMessage("Uygulama yüklenirken bir sorun oluştu (Kapat Butonu bulunamadı).", true);
            }

            createWheel(); // createWheel çağrısı wheel elementi atandıktan sonra yapılmalı
            initializeFirebase();
        });
    </script>
</body>
</html>
