<!--
  Bu dosya, bir Telegram Web Uygulaması'nı
  Firebase Firestore ile entegre ederek çok kullanıcılı ve
  gerçek zamanlı veri saklama özelliğine kavuşturur.
  Kullanıcılar bir mini oyundan puan kazanır ve bu puanlarla
  bir bonus çarkını çevirerek kodlar kazanabilir.
-->
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Çarkıfelek Web Uygulaması</title>
    <!-- Tailwind CSS'i dahil etme -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Telegram Web App SDK'sını dahil etme -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase SDK'larını uyumluluk (compat) modunda dahil etme -->
    <!-- Bu, `import` hatalarını önler ve `firebase` nesnesini global olarak erişilebilir kılar. -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <style>
        /* Varsayılan fontu ayarlama */
        html, body {
            height: 100%; /* HTML ve body'nin tam yüksekliği almasını sağlar */
            width: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tg-theme-bg-color, #f4f4f4);
            color: var(--tg-theme-text-color, #000000);
            display: flex;
            flex-direction: column; /* İçeriği dikeyde sırala */
            align-items: center; /* Yatayda ortala */
            justify-content: flex-start; /* İçeriği yukarıdan başlat */
            min-height: 100vh; /* En az viewport yüksekliği kadar olmasını sağla */
            padding: 1.5rem;
            overflow-y: auto; /* Dikeyde kaydırmaya izin ver */
            overflow-x: hidden; /* Yatayda kaydırmayı engelle */
            box-sizing: border-box; /* Padding'in genişliğe dahil olmasını sağla */
        }
        .telegram-btn {
            background-color: var(--tg-theme-button-color, #50a8eb);
            color: var(--tg-theme-button-text-color, #ffffff);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border-radius: 0.5rem; /* Yuvarlak köşeler */
        }
        /* Yükleme ekranı stili */
        #loading-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--tg-theme-bg-color, #f4f4f4);
            z-index: 9999;
        }
        .spinner {
            border: 4px solid var(--tg-theme-hint-color, #999);
            border-top: 4px solid var(--tg-theme-button-color, #50a8eb);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Mesaj kutusu için stil */
        #message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
            display: none;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        /* Çark stili */
        .wheel-container {
            position: relative;
            width: 280px; /* Daha büyük çark */
            height: 280px; /* Daha büyük çark */
            margin: 0 auto;
            border-radius: 50%;
            overflow: hidden; /* Dilimlerin dışarı taşmasını engelle */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            margin-bottom: 1.5rem; /* Altına boşluk bırak */
        }
        .wheel {
            position: relative; /* Dilimler için konteyner */
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transition: transform 5s cubic-bezier(0.1, 0.9, 0.2, 1); /* Hızlı başla, yavaş dur */
            transform-origin: center center;
            overflow: hidden; /* Dilimlerin dışarı taşmasını engelle */
        }
        .segment { /* Her bir çark diliminin kapsayıcısı */
            position: absolute;
            width: 50%;   /* Yarıçap kadar genişlik */
            height: 100%; /* Tam çap kadar yükseklik */
            top: 0;
            left: 50%;    /* Çarkın merkezinden başla */
            transform-origin: 0% 50%; /* Dönüş noktası çarkın merkezi */
            overflow: hidden; /* İçerideki renkli kısmı gizlemek için */
            transform: rotate(var(--rotation-angle)); /* Dilimi kendi yerine döndür */
        }
        .segment-color-fill { /* Dilimin renkli görünümünü veren kısım */
            position: absolute;
            width: 100%; /* Kapsayıcının tam genişliği */
            height: 100%; /* Kapsayıcının tam yüksekliği */
            left: 0;
            top: 0;
            background-color: var(--segment-color);
            transform-origin: 0% 50%; /* Kapsayıcının sol ortasından dön */
            transform: rotate(var(--segment-sweep-angle)); /* Dilimin yayını oluşturmak için döndür */
            border-radius: 0 100% 100% 0 / 50%; /* Yarım daire şekli */
        }
        .segment-label { /* Dilim üzerindeki okunabilir metin */
            position: absolute;
            top: 50%; /* Dikeyde ortala */
            left: 75%; /* Merkeze göre dışa doğru konumlandır */
            transform: translate(-50%, -50%) rotate(calc(-1 * var(--rotation-angle))); /* Yatayda tutmak için karşıt dönüş */
            white-space: nowrap;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5); /* Okunabilirliği artır */
            z-index: 2; /* Metin dilimin üstünde olsun */
            pointer-events: none; /* Metnin tıklamayı engellememesi için */
            padding: 0 5px; /* Kenarlardan boşluk */
            box-sizing: border-box;
        }
        .wheel-marker {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid var(--tg-theme-button-color, #50a8eb);
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        .app-container {
            flex-shrink: 0; /* İçeriğin büyümesini engelleme */
            width: 100%;
            max-width: 600px; /* Daha geniş cihazlarda daha iyi görünüm */
            margin: auto; /* Ortalamak için */
            padding: 1.5rem; /* İç padding */
            box-sizing: border-box; /* Padding'in genişliğe dahil olmasını sağla */
        }
    </style>
</head>
<body class="p-6">
    <!-- Yükleme Ekranı -->
    <div id="loading-screen" class="space-y-4">
        <div class="spinner"></div>
        <p class="text-sm">Bağlanıyor...</p>
    </div>

    <div id="app-container" class="bg-white rounded-lg shadow-xl p-8 text-center hidden">
        <h1 class="text-3xl font-bold mb-2">Bonus Çarkı Uygulaması</h1>
        <p class="text-sm text-gray-600 mb-6">Puan kazanmak ve bonus kodları almak için oyna!</p>
        
        <!-- Kullanıcı Bilgisi -->
        <div class="bg-gray-100 p-4 rounded-lg mb-6">
            <p id="user-info" class="text-sm font-semibold mb-2">Yükleniyor...</p>
            <p id="points-display" class="text-2xl font-bold text-blue-600">Puan: 0</p>
        </div>
        
        <!-- Mini Oyun Bölümü -->
        <div class="border-b border-gray-200 pb-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Mini Oyun</h2>
            <p class="text-sm text-gray-600 mb-4">Butona her tıkladığınızda puan kazanırsınız.</p>
            <button id="game-button" class="telegram-btn w-full py-3 rounded-lg font-semibold transition duration-200 hover:opacity-80">
                <span id="game-button-text">Puan Kazan (+10)</span>
            </button>
        </div>
        
        <!-- Çarkıfelek Bölümü -->
        <div class="border-b border-gray-200 pb-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Bonus Çarkı</h2>
            <p class="text-sm text-gray-600 mb-4">Çarkı çevirmek için 100 puana ihtiyacın var.</p>
            <div class="wheel-container">
                <div class="wheel-marker"></div>
                <div id="wheel" class="wheel">
                    <!-- Çark dilimleri ve metin etiketleri dinamik olarak eklenecek -->
                </div>
            </div>
            <button id="spin-button" class="telegram-btn w-full py-3 mt-6 rounded-lg font-semibold transition duration-200 hover:opacity-80 disabled:opacity-50" disabled>
                <span id="spin-button-text">Çarkı Çevir (100 Puan)</span>
            </button>
        </div>
        
        <!-- Bonus Kodları Bölümü -->
        <div>
            <h2 class="text-xl font-bold mb-4">Kazanılan Bonus Kodları</h2>
            <ul id="bonus-codes-list" class="text-sm text-gray-600 space-y-2">
                <!-- Bonus kodları buraya eklenecek -->
            </ul>
        </div>
        
        <!-- Mesaj kutusu öğesi -->
        <div id="message-box"></div>

        <!-- Uygulamayı kapatma butonu -->
        <button id="close-button" class="telegram-btn w-full py-3 mt-6 rounded-lg font-semibold transition duration-200 hover:opacity-80">
            Uygulamayı Kapat
        </button>
    </div>

    <script>
        // Firebase ve Uygulama Ayarlarını Global Değişkenlerden Alın
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Kendi firebaseConfig'inizi buraya yapıştırın.
        const firebaseConfig = {
            apiKey: "AIzaSyBnktrT7Pp7WucJP_xtEu_mmQle_VthRAE",
            authDomain: "onwingiris-afccf.firebaseapp.com",
            projectId: "onwingiris-afccf",
            storageBucket: "onwingiris-afccf.firebasestorage.app",
            messagingSenderId: "1059998132611",
            appId: "1:1059998132611:web:7f415159c54936cc796eb6",
            measurementId: "G-RE79PDJSJX"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId, userDocRef;
        let isSpinning = false;
        
        // Bonus çarkı için bölümler
        const segments = [
            { text: "10 TL Bonus", color: "#FF6384", type: "bonus_code" },
            { text: "Tekrar Dene", color: "#36A2EB", type: "try_again" },
            { text: "25 TL Bonus", color: "#FFCE56", type: "bonus_code" },
            { text: "Tekrar Dene", color: "#4BC0C0", type: "try_again" },
            { text: "50 TL Bonus", color: "#9966FF", type: "bonus_code" },
            { text: "Tekrar Dene", color: "#FF9F40", type: "try_again" },
            { text: "25 TL Bonus", color: "#B3F7B3", type: "bonus_code" },
            { text: "Tekrar Dene", color: "#E0E0E0", type: "try_again" }
        ];

        // HTML elemanları (DOMContentLoaded içinde tanımlanacak)
        let loadingScreen, appContainer, userInfoElement, pointsDisplay, gameButton, spinButton, bonusCodesL
