<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONWIN - Mini Games</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/4f721868c6.js" crossorigin="anonymous"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
        }
        
        #app-container {
            width: 100%;
            max-width: 600px;
            padding: 1rem;
            box-sizing: border-box;
        }

        .game-card-homepage {
            min-width: 140px;
            max-width: 160px;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            scroll-snap-align: center;
            background: linear-gradient(135deg, #1f2937 0%, #000000 100%);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .game-card-homepage:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }

        #mini-games-section, .banner-carousel {
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }

        #mini-games-section::-webkit-scrollbar, .banner-carousel::-webkit-scrollbar {
            height: 0;
        }

        .tab-button {
            transition: all 0.3s ease;
            position: relative;
            background-color: transparent;
            color: #9ca3af;
        }

        .tab-button.active {
            color: #ffffff;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 2px;
            background-color: #f59e0b;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        .modal-content {
            background-color: #1f2937;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            opacity: 0;
            animation: modal-enter 0.3s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes modal-enter {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Firebase SDK'leri -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, orderBy, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth, userId, userDocRef, authReady = false;
        let isDragging = false;
        let startX, scrollLeftStart;

        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authReady = true;
                        userDocRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/profile`, "data");
                        const userDocSnap = await getDoc(userDocRef);
                        const telegramUser = Telegram.WebApp.initDataUnsafe.user;
                        let username = telegramUser ? (telegramUser.first_name || 'Kullanıcı') : 'Kullanıcı';
                        let photoUrl = telegramUser ? telegramUser.photo_url : null;
                        
                        if (!userDocSnap.exists()) {
                            await setDoc(userDocRef, {
                                username: username,
                                points: 0,
                                lastSpin: new Date(0),
                                lastBonusClaim: new Date(0),
                                photoUrl: photoUrl
                            });
                        }
                        updateUI();
                    }
                });

                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                startRealtimeListeners();
                
            } catch (error) {
                console.error("Firebase başlatılırken bir hata oluştu:", error);
            }
        }

        window.onload = initializeFirebase;

        function startRealtimeListeners() {
            const userIdDisplay = document.getElementById('user-id-display');
            const userPointsDisplay = document.getElementById('user-points');
            const userProfilePic = document.getElementById('user-profile-pic');
            const userDocPath = `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/profile/data`;

            onSnapshot(doc(db, userDocPath), (doc) => {
                if (doc.exists()) {
                    const userData = doc.data();
                    const username = userData.username || 'Kullanıcı';
                    const points = userData.points || 0;
                    const photoUrl = userData.photoUrl || null;
                    
                    document.getElementById('username-display').textContent = username;
                    userPointsDisplay.textContent = points;
                    if (photoUrl) {
                        userProfilePic.style.backgroundImage = `url(${photoUrl})`;
                    } else {
                        userProfilePic.style.backgroundImage = `url('https://placehold.co/100x100/A0AEC0/000000?text=${username.charAt(0).toUpperCase()}')`;
                    }
                }
            }, (error) => {
                console.error("Kullanıcı verisi dinlenirken hata oluştu:", error);
            });
        }
        
        function updateUI() {
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
        }

        async function updatePoints(pointsToAdd) {
            try {
                if (!authReady) {
                    console.error("Firebase yetkilendirmesi hazır değil.");
                    return;
                }
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    const currentPoints = userDocSnap.data().points || 0;
                    await setDoc(userDocRef, { points: currentPoints + pointsToAdd }, { merge: true });
                }
            } catch (error) {
                console.error("Puanlar güncellenirken hata oluştu:", error);
            }
        }
    </script>
    
    <div id="loading-overlay" class="fixed inset-0 flex items-center justify-center bg-gray-900 z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-500"></div>
    </div>

    <div id="app-container" class="hidden">
        <header class="w-full max-w-5xl mx-auto flex flex-col items-center justify-center py-6 px-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-yellow-600 mb-2 tracking-wide text-shadow-lg">
                ONWIN
            </h1>
            <div class="flex items-center justify-center space-x-2 text-white/80">
                <i class="fa-solid fa-gem text-lg"></i>
                <span id="user-points" class="text-xl font-bold">0</span>
            </div>
            <div class="w-full flex justify-center items-center mt-4">
                <div class="user-info-display flex items-center bg-gray-800 rounded-full py-2 px-4 shadow-xl">
                    <div id="user-profile-pic" class="w-10 h-10 bg-center bg-cover rounded-full border-2 border-yellow-400"></div>
                    <span id="username-display" class="ml-3 font-semibold text-lg text-white"></span>
                </div>
            </div>
        </header>

        <div class="relative w-full max-w-5xl mx-auto mt-4 px-4">
            <h1 class="text-xl sm:text-2xl font-bold mb-4 text-center text-white">Hoş Geldiniz</h1>
            <div id="banner-container" class="relative w-full overflow-hidden rounded-xl shadow-lg">
                <div id="banner-carousel" class="flex flex-nowrap snap-x snap-mandatory scroll-container overflow-x-auto transition-transform duration-500 ease-in-out">
                    <!-- Banner 1 -->
                    <div class="flex-none w-full snap-start">
                        <div class="w-full aspect-video flex items-center justify-center p-4 text-center bg-purple-500 text-white rounded-xl">
                            <div class="max-w-md">
                                <h2 class="text-lg sm:text-xl font-semibold mb-2">Harika Fırsatları Keşfedin</h2>
                                <p class="text-sm sm:text-base opacity-90">Sadece size özel indirimler ve kampanyalar için hemen tıklayın!</p>
                            </div>
                        </div>
                    </div>
                    <!-- Banner 2 -->
                    <div class="flex-none w-full snap-start">
                        <div class="w-full aspect-video flex items-center justify-center p-4 text-center bg-teal-500 text-white rounded-xl">
                            <div class="max-w-md">
                                <h2 class="text-lg sm:text-xl font-semibold mb-2">Yeni Ürünlerimiz Geldi</h2>
                                <p class="text-sm sm:text-base opacity-90">En son çıkan ürünleri ilk siz görün.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Banner 3 -->
                    <div class="flex-none w-full snap-start">
                        <div class="w-full aspect-video flex items-center justify-center p-4 text-center bg-indigo-500 text-white rounded-xl">
                            <div class="max-w-md">
                                <h2 class="text-lg sm:text-xl font-semibold mb-2">Mobil Uygulamamızı İndirin</h2>
                                <p class="text-sm sm:text-base opacity-90">Daha hızlı ve pratik alışveriş için uygulamamızı indirmeyi unutmayın.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigasyon Butonları -->
                <button id="prevBtn" class="absolute top-1/2 left-2 transform -translate-y-1/2 bg-white bg-opacity-75 p-2 rounded-full shadow-md hover:bg-opacity-100 transition-all focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <button id="nextBtn" class="absolute top-1/2 right-2 transform -translate-y-1/2 bg-white bg-opacity-75 p-2 rounded-full shadow-md hover:bg-opacity-100 transition-all focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="w-full max-w-5xl mx-auto p-4 sm:p-6 bg-gray-800 rounded-xl shadow-lg mt-8">
            <div class="flex justify-around mb-6 space-x-2 sm:space-x-4">
                <button class="tab-button active flex-1 text-center py-3 rounded-xl hover:bg-gray-700 font-semibold text-lg" onclick="showTab('games')">
                    <i class="fa-solid fa-gamepad"></i> Oyunlar
                </button>
                <button class="tab-button flex-1 text-center py-3 rounded-xl hover:bg-gray-700 font-semibold text-lg" onclick="showTab('bonus-wheel')">
                    <i class="fa-solid fa-star"></i> Çark
                </button>
                <button class="tab-button flex-1 text-center py-3 rounded-xl hover:bg-gray-700 font-semibold text-lg" onclick="showTab('leaderboard')">
                    <i class="fa-solid fa-trophy"></i> Liderler
                </button>
                <button class="tab-button flex-1 text-center py-3 rounded-xl hover:bg-gray-700 font-semibold text-lg" onclick="showTab('bonus-codes')">
                    <i class="fa-solid fa-gift"></i> Kodlar
                </button>
            </div>

            <div id="games-tab" class="tab-content active">
                <h2 class="text-xl font-bold mb-4 text-center">Mini Oyunlar</h2>
                <div id="mini-games-section" class="flex overflow-x-auto gap-4 py-4 scroll-snap-x scroll-container">
                    <div id="click-game" class="game-card-homepage rounded-2xl p-4 flex flex-col items-center justify-center text-center shadow-lg transform active:scale-95 transition-all">
                        <i class="fa-solid fa-hand-pointer text-5xl mb-2 text-yellow-400"></i>
                        <span class="text-lg font-semibold text-white">Tıkla Kazan</span>
                        <span class="text-xs text-gray-400 mt-1">10 Puan</span>
                    </div>
                    <div id="number-game" class="game-card-homepage rounded-2xl p-4 flex flex-col items-center justify-center text-center shadow-lg transform active:scale-95 transition-all">
                        <i class="fa-solid fa-dice-one text-5xl mb-2 text-yellow-400"></i>
                        <span class="text-lg font-semibold text-white">Sayı Tahmini</span>
                        <span class="text-xs text-gray-400 mt-1">50 Puan</span>
                    </div>
                    <div id="rps-game" class="game-card-homepage rounded-2xl p-4 flex flex-col items-center justify-center text-center shadow-lg transform active:scale-95 transition-all">
                        <i class="fa-solid fa-hand-rock text-5xl mb-2 text-yellow-400"></i>
                        <span class="text-lg font-semibold text-white">Taş-Kağıt-Makas</span>
                        <span class="text-xs text-gray-400 mt-1">20 Puan</span>
                    </div>
                </div>
            </div>

            <div id="bonus-wheel-tab" class="tab-content hidden">
                <div class="flex flex-col items-center">
                    <h2 class="text-xl font-bold mb-4 text-center">Bonus Çarkı</h2>
                    <canvas id="wheelCanvas" width="280" height="280" class="rounded-full bg-gray-700 shadow-xl"></canvas>
                    <button id="spin-btn" class="mt-8 px-6 py-3 bg-gradient-to-r from-yellow-400 to-yellow-600 text-gray-900 font-bold rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
                        Çarkı Çevir
                    </button>
                    <p id="spin-status" class="mt-4 text-center text-sm text-gray-400"></p>
                </div>
            </div>

            <div id="leaderboard-tab" class="tab-content hidden">
                <h2 class="text-xl font-bold mb-4 text-center">Liderlik Tablosu</h2>
                <div id="leaderboard-list" class="bg-gray-700 rounded-xl p-4 space-y-3">
                    <p class="text-center text-gray-400">Yükleniyor...</p>
                </div>
            </div>

            <div id="bonus-codes-tab" class="tab-content hidden">
                <h2 class="text-xl font-bold mb-4 text-center">Bonus Kodları</h2>
                <div id="bonus-codes-list" class="bg-gray-700 rounded-xl p-4 space-y-3">
                    <p class="text-center text-gray-400">Henüz kazanılmış bir kodunuz yok.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="game-modal-overlay" class="modal-overlay hidden">
        <div id="game-modal-content" class="modal-content bg-gray-800 text-white p-6 rounded-xl shadow-2xl text-center">
            <h3 id="modal-title" class="text-2xl font-bold mb-4"></h3>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <div id="modal-body"></div>
            <button id="modal-close-btn" class="mt-6 px-6 py-2 bg-gray-700 text-white rounded-full hover:bg-gray-600 transition-colors">
                Kapat
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, orderBy, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth, userId, userDocRef, authReady = false;
        let isDragging = false;
        let startX, scrollLeftStart;

        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authReady = true;
                        userDocRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/profile`, "data");
                        const userDocSnap = await getDocs(userDocRef);
                        const telegramUser = Telegram.WebApp.initDataUnsafe.user;
                        let username = telegramUser ? (telegramUser.first_name || 'Kullanıcı') : 'Kullanıcı';
                        let photoUrl = telegramUser ? telegramUser.photo_url : null;
                        
                        if (!userDocSnap.exists()) {
                            await setDoc(userDocRef, {
                                username: username,
                                points: 0,
                                lastSpin: new Date(0),
                                lastBonusClaim: new Date(0),
                                photoUrl: photoUrl
                            });
                        }
                        updateUI();
                    }
                });

                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                startRealtimeListeners();
                
            } catch (error) {
                console.error("Firebase başlatılırken bir hata oluştu:", error);
            }
        }

        window.onload = initializeFirebase;

        function startRealtimeListeners() {
            const userPointsDisplay = document.getElementById('user-points');
            const userProfilePic = document.getElementById('user-profile-pic');
            const userDocPath = `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/profile/data`;

            onSnapshot(doc(db, userDocPath), (doc) => {
                if (doc.exists()) {
                    const userData = doc.data();
                    const username = userData.username || 'Kullanıcı';
                    const points = userData.points || 0;
                    const photoUrl = userData.photoUrl || null;
                    
                    document.getElementById('username-display').textContent = username;
                    userPointsDisplay.textContent = points;
                    if (photoUrl) {
                        userProfilePic.style.backgroundImage = `url(${photoUrl})`;
                    } else {
                        userProfilePic.style.backgroundImage = `url('https://placehold.co/100x100/A0AEC0/000000?text=${username.charAt(0).toUpperCase()}')`;
                    }
                }
            }, (error) => {
                console.error("Kullanıcı verisi dinlenirken hata oluştu:", error);
            });
        }
        
        function updateUI() {
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
        }

        async function updatePoints(pointsToAdd) {
            try {
                if (!authReady) {
                    console.error("Firebase yetkilendirmesi hazır değil.");
                    return;
                }
                const userDocSnap = await getDocs(userDocRef);
                if (userDocSnap.exists()) {
                    const currentPoints = userDocSnap.data().points || 0;
                    await setDoc(userDocRef, { points: currentPoints + pointsToAdd }, { merge: true });
                }
            } catch (error) {
                console.error("Puanlar güncellenirken hata oluştu:", error);
            }
        }

        // Tab and Carousel Logic
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.getElementById(tabId + '-tab').style.display = 'block';
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
        }

        // Game Modals and Logic
        const gameModalOverlay = document.getElementById('game-modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        function showModal(title, message, bodyContent = '') {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalBody.innerHTML = bodyContent;
            gameModalOverlay.classList.remove('hidden');
        }

        modalCloseBtn.onclick = () => {
            gameModalOverlay.classList.add('hidden');
        };

        // Mini Games Logic
        document.getElementById('click-game').onclick = () => {
            if (Telegram.WebApp) { Telegram.WebApp.HapticFeedback.impactOccurred('light'); }
            updatePoints(10);
            showModal('Tıkla Kazan', '10 Puan kazandınız!', '<p>Tebrikler!</p>');
        };

        document.getElementById('number-game').onclick = () => {
            if (Telegram.WebApp) { Telegram.WebApp.HapticFeedback.impactOccurred('light'); }
            showModal('Sayı Tahmini', '1 ile 10 arasında bir sayı tahmin edin.',
                `<input type="number" id="guess-input" class="w-full text-center p-2 mb-4 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 transition-all" min="1" max="10">
                <button id="guess-btn" class="px-6 py-3 bg-gradient-to-r from-yellow-400 to-yellow-600 text-gray-900 font-bold rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
                    Tahmin Et
                </button>`);
            document.getElementById('guess-btn').onclick = () => {
                const guess = parseInt(document.getElementById('guess-input').value);
                const randomNumber = Math.floor(Math.random() * 10) + 1;
                if (guess === randomNumber) {
                    updatePoints(50);
                    showModal('Tebrikler!', `Doğru bildiniz! Kazandığınız puan: 50`);
                } else {
                    showModal('Yanlış Tahmin', `Tahmininiz yanlış. Doğru sayı ${randomNumber} idi.`);
                }
            };
        };

        document.getElementById('rps-game').onclick = () => {
            if (Telegram.WebApp) { Telegram.WebApp.HapticFeedback.impactOccurred('light'); }
            showModal('Taş-Kağıt-Makas', 'Seçiminizi yapın:',
                `<div class="flex justify-center space-x-4">
                    <button class="choice-btn px-6 py-3 bg-gray-700 text-white rounded-full hover:bg-gray-600 transition-colors" data-choice="taş">Taş</button>
                    <button class="choice-btn px-6 py-3 bg-gray-700 text-white rounded-full hover:bg-gray-600 transition-colors" data-choice="kağıt">Kağıt</button>
                    <button class="choice-btn px-6 py-3 bg-gray-700 text-white rounded-full hover:bg-gray-600 transition-colors" data-choice="makas">Makas</button>
                </div>`);
            document.querySelectorAll('.choice-btn').forEach(button => {
                button.onclick = (e) => {
                    const playerChoice = e.target.dataset.choice;
                    const choices = ['taş', 'kağıt', 'makas'];
                    const computerChoice = choices[Math.floor(Math.random() * choices.length)];

                    let resultMessage;
                    if (playerChoice === computerChoice) {
                        resultMessage = 'Berabere! Her ikiniz de ' + playerChoice + ' seçtiniz.';
                    } else if (
                        (playerChoice === 'taş' && computerChoice === 'makas') ||
                        (playerChoice === 'kağıt' && computerChoice === 'taş') ||
                        (playerChoice === 'makas' && computerChoice === 'kağıt')
                    ) {
                        updatePoints(20);
                        resultMessage = `Kazandınız! Siz ${playerChoice}, rakip ${computerChoice} seçti.`;
                    } else {
                        resultMessage = `Kaybettiniz! Siz ${playerChoice}, rakip ${computerChoice} seçti.`;
                    }
                    showModal('Sonuç', resultMessage);
                };
            });
        };

        // Spin Wheel Logic
        const wheelCanvas = document.getElementById('wheelCanvas');
        const spinBtn = document.getElementById('spin-btn');
        const spinStatus = document.getElementById('spin-status');
        const ctx = wheelCanvas.getContext('2d');
        const segments = [{
            text: "10 Puan",
            value: 10
        }, {
            text: "50 Puan",
            value: 50
        }, {
            text: "100 Puan",
            value: 100
        }, {
            text: "0 Puan",
            value: 0
        }, {
            text: "200 Puan",
            value: 200
        }, {
            text: "0 Puan",
            value: 0
        }];
        const deg = 360 / segments.length;
        let rotation = 0;

        function drawWheel() {
            ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
            segments.forEach((segment, i) => {
                ctx.beginPath();
                ctx.moveTo(140, 140);
                ctx.arc(140, 140, 140, (i * deg) * Math.PI / 180, ((i + 1) * deg) * Math.PI / 180);
                ctx.closePath();
                ctx.fillStyle = i % 2 === 0 ? '#10B981' : '#EF4444';
                ctx.fill();

                ctx.save();
                ctx.translate(140, 140);
                ctx.rotate(((i * deg + deg / 2) * Math.PI / 180));
                ctx.textAlign = 'center';
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 16px Inter';
                ctx.fillText(segment.text, 0, -100);
                ctx.restore();
            });
        }
        drawWheel();

        spinBtn.onclick = async () => {
            if (!authReady) {
                showModal("Hata", "Lütfen girişin tamamlanmasını bekleyin.");
                return;
            }
            if (Telegram.WebApp) { Telegram.WebApp.HapticFeedback.impactOccurred('medium'); }

            const userDocSnap = await getDocs(userDocRef);
            if (!userDocSnap.exists()) {
                showModal("Hata", "Kullanıcı verisi bulunamadı.");
                return;
            }
            const userData = userDocSnap.data();
            const lastSpin = userData.lastSpin.toDate();
            const now = new Date();
            const timeDiff = now - lastSpin;
            const cooldown = 24 * 60 * 60 * 1000; // 24 saat

            if (timeDiff < cooldown) {
                const remainingTime = new Date(cooldown - timeDiff);
                const hours = remainingTime.getUTCHours();
                const minutes = remainingTime.getUTCMinutes();
                const seconds = remainingTime.getUTCSeconds();
                showModal("Beklemede", `Bir sonraki çark çevirme için kalan süre: ${hours}sa ${minutes}dk ${seconds}sn`);
                return;
            }

            spinBtn.disabled = true;
            spinStatus.textContent = "Çark dönüyor...";
            
            const spinTo = (Math.floor(Math.random() * 360) + 360 * 5); // 5 tam tur + rastgele
            let currentRotation = rotation;
            let start = null;

            function animate(timestamp) {
                if (!start) start = timestamp;
                const progress = timestamp - start;
                const rotationDelta = (spinTo / 2000) * progress;
                rotation = currentRotation + rotationDelta;

                ctx.save();
                ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
                ctx.translate(140, 140);
                ctx.rotate(rotation * Math.PI / 180);
                ctx.translate(-140, -140);
                drawWheel();
                ctx.restore();

                if (progress < 2000) {
                    requestAnimationFrame(animate);
                } else {
                    spinBtn.disabled = false;
                    rotation %= 360;
                    const finalRotation = rotation;
                    const finalIndex = Math.floor((360 - (finalRotation % 360)) / deg);
                    const finalSegment = segments[finalIndex];
                    spinStatus.textContent = `Tebrikler! ${finalSegment.text} kazandınız.`;

                    updatePoints(finalSegment.value);
                    setDoc(userDocRef, { lastSpin: now }, { merge: true });
                }
            }
            requestAnimationFrame(animate);
        };

        // Leaderboard Logic
        document.getElementById('leaderboard-tab').onclick = async () => {
            if (!authReady) {
                showModal("Hata", "Lütfen girişin tamamlanmasını bekleyin.");
                return;
            }
            const leaderboardList = document.getElementById('leaderboard-list');
            try {
                const leaderboardCollection = collection(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users`);
                const q = query(leaderboardCollection, orderBy("profile.data.points", "desc"));
                const querySnapshot = await getDocs(q);

                leaderboardList.innerHTML = '';
                let rank = 1;
                querySnapshot.forEach((userDoc) => {
                    const userData = userDoc.data().profile.data;
                    const username = userData.username || 'Anonim';
                    const points = userData.points || 0;
                    const isCurrentUser = userDoc.id === userId;
                    
                    const leaderboardItem = document.createElement('div');
                    leaderboardItem.className = `flex justify-between items-center p-3 rounded-lg ${isCurrentUser ? 'bg-yellow-500 bg-opacity-30 text-yellow-300 font-bold' : 'bg-gray-800'}`;
                    leaderboardItem.innerHTML = `
                        <span>#${rank} ${username}</span>
                        <span>${points} Puan</span>
                    `;
                    leaderboardList.appendChild(leaderboardItem);
                    rank++;
                });
            } catch (e) {
                console.error("Liderlik tablosu yüklenirken hata:", e);
                leaderboardList.innerHTML = `<p class="text-center text-red-400">Liderlik tablosu yüklenemedi.</p>`;
            }
        };

        // Banner Carousel Logic
        const bannerCarousel = document.getElementById('banner-carousel');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const totalBanners = bannerCarousel.children.length;
        let currentIndex = 0;

        function updateButtons() {
            prevBtn.style.display = currentIndex === 0 ? 'none' : 'block';
            nextBtn.style.display = currentIndex === totalBanners - 1 ? 'none' : 'block';
        }

        prevBtn.addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                bannerCarousel.scrollBy({
                    left: -bannerCarousel.offsetWidth,
                    behavior: 'smooth'
                });
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentIndex < totalBanners - 1) {
                currentIndex++;
                bannerCarousel.scrollBy({
                    left: bannerCarousel.offsetWidth,
                    behavior: 'smooth'
                });
            }
        });
        
        bannerCarousel.addEventListener('scroll', () => {
            const scrollLeft = bannerCarousel.scrollLeft;
            const newIndex = Math.round(scrollLeft / bannerCarousel.offsetWidth);
            if (currentIndex !== newIndex) {
                currentIndex = newIndex;
                updateButtons();
            }
        });

        // initial call
        updateButtons();
    </script>
</body>
</html>
